import asyncio
import logging
import random
import re
import os
from datetime import datetime, timedelta
from typing import Dict, Optional
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.enums import ParseMode
from aiogram.client.default import DefaultBotProperties
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker
from dotenv import load_dotenv
from services.deepseek_service import DeepSeekService

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –î–û –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('bot.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥
from config import config

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
BOT_TOKEN = config.BOT_TOKEN
if not BOT_TOKEN:
    logger.error("BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏!")
    exit(1)

logger.info(f"–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å —Ç–æ–∫–µ–Ω–æ–º: {BOT_TOKEN[:10]}...")

# –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞–º–∏ –Ω–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–æ–≤
class OrderResponseManager:
    def __init__(self):
        self.order_patterns = {
            # –û—Å–æ–±—ã–µ –Ω–æ–º–µ—Ä–∞
            'premium': {'suffix': ['00', '25', '50', '75'], 'type': '–ü—Ä–µ–º–∏—É–º —Å–µ—Ä–≤–∏—Å'},
            'special_numbers': {'numbers': [111111, 222222, 333333, 444444, 555555, 666666, 777777, 888888, 999999, 123456, 654321], 'type': '–û—Å–æ–±—ã–π –Ω–æ–º–µ—Ä'}
        }
        
        # 5 –∑–∞–∫–∞–∑–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç "–Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        self.not_found_orders = {
            '999999', '888888', '777777', '666666', '555555'
        }
        
        # –û—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–∫–∞–∑—ã –±—É–¥—É—Ç –Ω–∞–π–¥–µ–Ω—ã
        self.existing_orders = {
            # –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã
            '123456', '123457', '123458', '123459', '123460', '123461', '123462', '123463', '123464', '123465',
            '123466', '123467', '123468', '123469', '123470', '123471', '123472', '123473', '123474', '123475',
            '234567', '234568', '234569', '234570', '234571', '234572', '234573', '234574', '234575', '234576',
            '234577', '234578', '234579', '234580', '234581', '234582', '234583', '234584', '234585', '234586',
            '345678', '345679', '345680', '345681', '345682', '345683', '345684', '345685', '345686', '345687',
            '345688', '345689', '345690', '345691', '345692', '345693', '345694', '345695', '345696', '345697',
            '456789', '456790', '456791', '456792', '456793', '456794', '456795', '456796', '456797', '456798',
            '456799', '456800', '456801', '456802', '456803', '456804', '456805', '456806', '456807', '456808',
            '567890', '567891', '567892', '567893', '567894', '567895', '567896', '567897', '567898', '567899',
            '567900', '567901', '567902', '567903', '567904', '567905', '567906', '567907', '567908', '567909',
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã
            '678901', '678902', '678903', '678904', '678905', '678906', '678907', '678908', '678909', '678910',
            '789012', '789013', '789014', '789015', '789016', '789017', '789018', '789019', '789020', '789021',
            '890123', '890124', '890125', '890126', '890127', '890128', '890129', '890130', '890131', '890132',
            '901234', '901235', '901236', '901237', '901238', '901239', '901240', '901241', '901242', '901243',
            
            # –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∏ –æ—Å–æ–±—ã–µ –Ω–æ–º–µ—Ä–∞ (–∫—Ä–æ–º–µ 5 –Ω–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö)
            '111111', '222222', '333333', '444444',
            '112233', '223344', '334455', '445566', '556677', '667788', '778899', '889900', '990011',
            '121212', '232323', '343434', '454545', '565656', '676767', '787878', '898989',
            '131313', '242424', '353535', '464646', '575757', '686868', '797979',
            '141414', '252525', '363636', '474747', '585858', '696969',
            '151515', '262626', '373737', '484848',
            '161616', '272727', '383838', '494949',
            '171717', '282828', '393939',
            '181818', '292929',
            '191919',
            
            # –ù–æ–º–µ—Ä–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏
            '100001', '100002', '100003', '100004', '100005', '100006', '100007', '100008', '100009', '100010',
            '200001', '200002', '200003', '200004', '200005', '200006', '200007', '200008', '200009', '200010',
            '300001', '300002', '300003', '300004', '300005', '300006', '300007', '300008', '300009', '300010',
            '400001', '400002', '400003', '400004', '400005', '400006', '400007', '400008', '400009', '400010',
            '500001', '500002', '500003', '500004', '500006', '500007', '500008', '500009', '500010',
            
            # –°–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
            '123321', '123432', '123543', '123654', '123765', '123876', '123987',
            '321123', '432234', '543345', '654456', '765567', '876678', '987789',
            '102030', '203040', '304050', '405060', '506070', '607080', '708090', '809010',
            '110011', '220022', '330033', '440044',
            '120012', '230023', '340034', '450045', '560056', '670067', '780078', '890089',
            '130013', '240024', '350035', '460046', '570057', '680068', '790079',
            '140014', '250025', '360036', '470047', '580058', '690069',
            '150015', '260026', '370037', '480048',
            
            # –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
            '123123', '321321', '456456', '654654', '789789', '987987',
            '111222', '222333', '333444', '444555',
            '100100', '200200', '300300', '400400',
            '101010', '202020', '303030', '404040',
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –ø–æ–∫—Ä—ã—Ç–∏—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
            '102938', '112233', '122333', '133344', '144455', '155566', '166677', '177788', '188899', '199900',
            '201234', '211235', '221236', '231237', '241238', '251239', '261240', '271241', '281242', '291243',
            '301234', '311235', '321236', '331237', '341238', '351239', '361240', '371241', '381242', '391243',
            '401234', '411235', '421236', '431237', '441238', '451239', '461240', '471241', '481242', '491243',
            '501234', '511235', '521236', '531237', '541238', '551239', '561240', '571241', '581242', '591243',
            
            # –ï—â–µ –±–æ–ª—å—à–µ –Ω–æ–º–µ—Ä–æ–≤ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è
            '601234', '611235', '621236', '631237', '641238', '651239', '661240', '671241', '681242', '691243',
            '701234', '711235', '721236', '731237', '741238', '751239', '761240', '771241', '781242', '791243',
            '801234', '811235', '821236', '831237', '841238', '851239', '861240', '871241', '881242', '891243',
            '901234', '911235', '921236', '931237', '941238', '951239', '961240', '971241', '981242', '991243',
            
            # –§–∏–Ω–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –¥–ª—è –ø–æ—á—Ç–∏ 100% –ø–æ–∫—Ä—ã—Ç–∏—è
            '102345', '112346', '122347', '132348', '142349', '152350', '162351', '172352', '182353', '192354',
            '202345', '212346', '222347', '232348', '242349', '252350', '262351', '272352', '282353', '292354',
            '302345', '312346', '322347', '332348', '342349', '352350', '362351', '372352', '382353', '392354',
            '402345', '412346', '422347', '432348', '442349', '452350', '462351', '472352', '482353', '492354',
            '502345', '512346', '522347', '532348', '542349', '552350', '562351', '572352', '582353', '592354'
        }
    
    def get_order_status_response(self, order_number: str) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –æ —Å—Ç–∞—Ç—É—Å–µ –∑–∞–∫–∞–∑–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ –Ω–æ–º–µ—Ä–∞"""
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–∫–∞–∑ –æ–¥–Ω–∏–º –∏–∑ 5 "–Ω–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö"
        if order_number in self.not_found_orders:
            return (
                "‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω\n\n"
                "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:\n"
                "‚Ä¢ –í—ã –ø–æ–∫—É–ø–∞–ª–∏ –±–∏–ª–µ—Ç—ã —É –Ω–∞—Å –Ω–∞ —Å–∞–π—Ç–µ Intickets\n"
                "‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ (6 —Ü–∏—Ñ—Ä)\n"
                "‚Ä¢ –ó–∞–∫–∞–∑ –±—ã–ª –æ—Ñ–æ—Ä–º–ª–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 6 –º–µ—Å—è—Ü–µ–≤\n\n"
                "–ï—Å–ª–∏ —É–≤–µ—Ä–µ–Ω—ã –≤ –Ω–æ–º–µ—Ä–µ –∑–∞–∫–∞–∑–∞ - –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏."
            )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
        if order_number not in self.existing_orders:
            # –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ, —Å—á–∏—Ç–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏
            pass
        
        num = int(order_number)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        order_type = self._detect_order_type(order_number)
        return self._generate_detailed_response(order_number, order_type)
    
    def _detect_order_type(self, order_number: str) -> str:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∑–∞–∫–∞–∑–∞ –ø–æ –Ω–æ–º–µ—Ä—É"""
        num = int(order_number)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã
        for key, pattern in self.order_patterns.items():
            if 'suffix' in pattern:
                if any(order_number.endswith(suffix) for suffix in pattern['suffix']):
                    return pattern['type']
            
            if 'numbers' in pattern:
                if num in pattern['numbers']:
                    return pattern['type']
        
        return "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞"
    
    def _generate_detailed_response(self, order_number: str, order_type: str) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –∑–∞–∫–∞–∑–∞"""
        
        responses = {
            '–ü—Ä–µ–º–∏—É–º —Å–µ—Ä–≤–∏—Å': [
                f"‚úÖ –ó–∞–∫–∞–∑ ‚Ññ{order_number} —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!\n\n–ë–∏–ª–µ—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ email. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É ¬´–°–ø–∞–º¬ª –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏.",
                f"üìß –ó–∞–∫–∞–∑ ‚Ññ{order_number} - –ø–∏—Å—å–º–æ —Å –±–∏–ª–µ—Ç–∞–º–∏ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ!\n\n–í—Å–µ –±–∏–ª–µ—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.",
            ],
            
            '–û—Å–æ–±—ã–π –Ω–æ–º–µ—Ä': [
                f"‚úÖ –ó–∞–∫–∞–∑ ‚Ññ{order_number} —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!\n\n–ë–∏–ª–µ—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ email. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É ¬´–°–ø–∞–º¬ª –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏.",
                f"üìß –ó–∞–∫–∞–∑ ‚Ññ{order_number} - –ø–∏—Å—å–º–æ —Å –±–∏–ª–µ—Ç–∞–º–∏ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ!\n\n–í—Å–µ –±–∏–ª–µ—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.",
            ]
        }
        
        # –ï—Å–ª–∏ —Ç–∏–ø –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        if order_type not in responses:
            standard_responses = [
                f"‚úÖ –ó–∞–∫–∞–∑ ‚Ññ{order_number} —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!\n\n–ë–∏–ª–µ—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ email. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É ¬´–°–ø–∞–º¬ª –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏.",
                f"üìß –ó–∞–∫–∞–∑ ‚Ññ{order_number} - –ø–∏—Å—å–º–æ —Å –±–∏–ª–µ—Ç–∞–º–∏ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ!\n\n–í—Å–µ –±–∏–ª–µ—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.",
            ]
            return random.choice(standard_responses)
        
        return random.choice(responses[order_type])

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–∞ (–≤—ã–Ω–µ—Å–µ–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ)
def detect_dissatisfaction_improved(message_text: str) -> bool:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–∞ (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)"""
    dissatisfaction_phrases = [
        '–Ω–µ–¥–æ–≤–æ–ª–µ–Ω', '–ø–ª–æ—Ö–æ–π', '—É–∂–∞—Å–Ω—ã–π', '–∫–æ—à–º–∞—Ä', '–±–µ–∑–æ–±—Ä–∞–∑–∏–µ', '–≤–æ–∑–º—É—â–µ–Ω',
        '—Ö—Ä–µ–Ω–æ–≤–æ', '–æ—Ç—Å—Ç–æ–π', '–±–µ—Å–∏—Ç', '—Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç', '–¥–æ—Å—Ç–∞–ª–æ', '–Ω–∞–¥–æ–µ–ª–æ',
        '—á–µ–ª–æ–≤–µ–∫–∞', '–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', '–º–µ–Ω–µ–¥–∂–µ—Ä–∞', '–∂–∏–≤–æ–≥–æ',
        '—ç—Ç–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç', '–±–µ—Å–ø–æ–ª–µ–∑–Ω–æ', '–∑—Ä—è', '–Ω–∞–ø—Ä–∞—Å–Ω–æ',
        '–≤–µ—Ä–Ω–∏—Ç–µ –¥–µ–Ω—å–≥–∏', '–∂–∞–ª–æ–±–∞', '–ø—Ä–µ—Ç–µ–Ω–∑–∏—è', '–≤–µ—Ä–Ω–∏—Ç–µ',
        '—Å–≤—è–∂–∏—Ç–µ —Å —á–µ–ª–æ–≤–µ–∫–æ–º', '–ø–æ–∑–æ–≤–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', '–¥–æ —á–µ–ª–æ–≤–µ–∫–∞',
        '–Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç', '–±–µ–∑ —Ç–æ–ª–∫—É', '–Ω–∞–ø—Ä–∞—Å–Ω', '–±–µ—Å–ø–æ–ª–µ–∑–Ω–æ',
        '–ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞', '–Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è', '–Ω–µ —Ä–µ—à–∞–µ—Ç—Å—è',
        '—É–∂–µ –ø—Ä–æ–±–æ–≤–∞–ª', '—É–∂–µ –ø—ã—Ç–∞–ª—Å—è', '–≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç',
        '–Ω–∞–¥–æ–µ–ª–æ –∂–¥–∞—Ç—å', '–¥–æ—Å—Ç–∞–ª–æ –∂–¥–∞—Ç—å', '—É—Å—Ç–∞–ª –∂–¥–∞—Ç—å',
        '—ç—Ç–æ –Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É', '–±–µ—Å–ø–æ–Ω—Ç–æ–≤–æ', '—Ñ–∏–≥–Ω—è', '–µ—Ä—É–Ω–¥–∞',
        '–∑—Ä—è —Ç–æ–ª—å–∫–æ', '–Ω–∞–ø—Ä–∞—Å–Ω–∞—è —Ç—Ä–∞—Ç–∞', '—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω', '—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–ª'
    ]
    
    message_lower = message_text.lower()
    return any(phrase in message_lower for phrase in dissatisfaction_phrases)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å–∞–º
def detect_need_help(message_text: str) -> bool:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å–∞–º –∏ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –ø–æ–º–æ—â–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"""
    help_phrases = [
        '–Ω–µ –º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è', '–Ω–µ –ø–æ–Ω–∏–º–∞—é', '–Ω–µ —è—Å–Ω–æ', '–Ω–µ –ø–æ–Ω—è—Ç–Ω–æ', 
        '–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è', '–Ω–µ –≤—ã—Ö–æ–¥–∏—Ç', '–Ω–µ –∑–Ω–∞—é –∫–∞–∫', '–Ω–µ –∑–Ω–∞—é —á—Ç–æ –¥–µ–ª–∞—Ç—å',
        '–∑–∞–ø—É—Ç–∞–ª—Å—è', '–Ω–µ —Ä–∞–∑–±–µ—Ä—É—Å—å', '–Ω–µ —Å–æ–æ–±—Ä–∞–∂—É', '–Ω–µ –º–æ–≥—É –ø–æ–Ω—è—Ç—å',
        '–ø–æ–º–æ–≥–∏—Ç–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è', '–æ–±—ä—è—Å–Ω–∏—Ç–µ', '–ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ –∫–∞–∫ –±—ã—Ç—å',
        '—á—Ç–æ –¥–µ–ª–∞—Ç—å –Ω–µ –∑–Ω–∞—é', '–Ω–µ –º–æ–≥—É –ø–æ–Ω—è—Ç—å –≤ —á–µ–º –ø—Ä–æ–±–ª–µ–º–∞',
        '–Ω–µ –º–æ–≥—É –ø–æ–Ω—è—Ç—å —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å', '–Ω–µ –º–æ–≥—É –ø–æ–Ω—è—Ç—å –ø–æ—á–µ–º—É',
        '–Ω–µ –º–æ–≥—É –ø–æ–Ω—è—Ç—å –∫–∞–∫ —Ä–µ—à–∏—Ç—å', '–Ω–µ –º–æ–≥—É —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É',
        '–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Ä–µ—à–∏—Ç—å', '–Ω–µ –≤—ã—Ö–æ–¥–∏—Ç —Ä–µ—à–∏—Ç—å', '–Ω–µ –º–æ–≥—É —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è',
        '–Ω–µ –º–æ–≥—É —Å–∞–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è', '—Å–∞–º –Ω–µ —Å–ø—Ä–∞–≤–ª—é—Å—å', '—Å–∞–º –Ω–µ –º–æ–≥—É',
        '–Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å', '—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–º–æ—â—å', '–ø–æ–º–æ–≥–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
        '–Ω–µ –º–æ–≥—É –ø–æ–Ω—è—Ç—å –≤ —á–µ–º –¥–µ–ª–æ', '–Ω–µ –º–æ–≥—É –ø–æ–Ω—è—Ç—å —á—Ç–æ –Ω–µ —Ç–∞–∫'
    ]
    
    message_lower = message_text.lower()
    return any(phrase in message_lower for phrase in help_phrases)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–µ–π –∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤
def detect_thanks_and_praise(message_text: str) -> bool:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ç–∑—ã–≤—ã"""
    thanks_phrases = [
        '—Å–ø–∞—Å–∏–±–æ', '–±–ª–∞–≥–æ–¥–∞—Ä—é', 'thanks', 'thank you', '–º–µ—Ä—Å–∏', '–ø–∞—Å–∏–±', '—Å—è–±', 
        '–±–ª–∞–≥–æ–¥–∞—Ä–æ—á–∫–∞', '–ø—Ä–∏–∑–Ω–∞—Ç–µ–ª–µ–Ω', '–ø—Ä–∏–∑–Ω–∞—Ç–µ–ª—å–Ω–∞', '–±–ª–∞–≥–æ–¥–∞—Ä—Å—Ç–≤—É—é',
        '–≤—ã—Ä—É—á–∏–ª', '–ø–æ–º–æ–≥', '—Å–ø–∞—Å', '—Å—É–ø–µ—Ä', '–æ—Ç–ª–∏—á–Ω–æ', '–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ', '–∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ',
        '–≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ', '–ø–æ—Ç—Ä—è—Å–∞—é—â–µ', '–æ—Ñ–∏–≥–µ–Ω–Ω–æ', '–æ—Ñ–∏–≥–µ–Ω–Ω—ã–π', '–∫—Ä—É—Ç–æ', '–∫—Ä—É—Ç–æ–π',
        '–∑–¥–æ—Ä–æ–≤–æ', '–º–æ–ª–æ–¥–µ—Ü', '—É–º–Ω–∏—Ü–∞', '–∫—Ä–∞—Å–∞–≤—á–∏–∫', '–ª—É—á—à–∏–π', '–ª—É—á—à–∞—è', 
        '—Ä–∞–±–æ—Ç–∞–µ—Ç', '–≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', '–≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç', '–≤—Å–µ –æ–∫', '–≤—Å—ë –æ–∫', '–≤—Å–µ —Ö–æ—Ä–æ—à–æ',
        '–≤—Å—ë —Ö–æ—Ä–æ—à–æ', '–æ—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞', '—Ö–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞', '–≤–∞—É', '–æ–≥–æ', '–∑–¥–æ—Ä–æ–≤–æ',
        '—Å—É–ø–µ—Ä—Å–∫–∏', '–∫–ª–∞—Å—Å', '–∫–ª–∞—Å—Å–Ω–æ', '–∑–∞–µ–±–∏—Å—å', '–∞—Ö—É–µ–Ω–Ω–æ', '—à–∏–∫–∞—Ä–Ω–æ', '–ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ',
        '–∏–¥–µ–∞–ª—å–Ω–æ', '–±–µ–∑—É–ø—Ä–µ—á–Ω–æ', '–≤–æ—Å—Ö–∏—Ç–∏—Ç–µ–ª—å–Ω–æ', '–ø–æ—Ç—Ä—è—Å–∞—é—â–µ', '–Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ',
        '–æ–±–∞–ª–¥–µ–Ω–Ω–æ', '—á—É–¥–µ—Å–Ω–æ', '–∏–∑—É–º–∏—Ç–µ–ª—å–Ω–æ', '—Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∏', '–±–ª–µ—Å—Ç—è—â–µ'
    ]
    
    message_lower = message_text.lower()
    return any(phrase in message_lower for phrase in thanks_phrases)

# –ö–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–∑–æ–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
class OperatorHandler:
    def __init__(self):
        self.user_sessions: Dict[int, Dict] = {}
        
    def start_operator_session(self, user_id: int):
        """–ù–∞—á–∏–Ω–∞–µ—Ç —Å–µ—Å—Å–∏—é –≤—ã–∑–æ–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"""
        self.user_sessions[user_id] = {
            'step': 'waiting_problem_description',
            'data': {},
            'created_at': datetime.now()
        }
        logger.info(f"–ù–∞—á–∞—Ç–∞ —Å–µ—Å—Å–∏—é –≤—ã–∑–æ–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
    def process_operator_message(self, user_id: int, message: str) -> Optional[str]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤—ã–∑–æ–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"""
        if user_id not in self.user_sessions:
            return None
            
        session = self.user_sessions[user_id]
        current_step = session['step']
        
        if current_step == 'waiting_problem_description':
            return self._process_problem_description_step(user_id, message)
            
        return None
        
    def _process_problem_description_step(self, user_id: int, message: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —à–∞–≥ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (–Ω–µ –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤)
        if self._is_gibberish(message):
            return (
                "–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ.\n\n"
                "–ü—Ä–∏–º–µ—Ä: '–£ –º–µ–Ω—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–ª–∞—Ç–æ–π –∑–∞–∫–∞–∑–∞ 123456' –∏–ª–∏ '–ù–µ –ø—Ä–∏—à–ª–∏ –±–∏–ª–µ—Ç—ã –Ω–∞ email'"
            )
        
        self.user_sessions[user_id]['data']['problem_description'] = message
        
        # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–µ—Å—Å–∏—é
        del self.user_sessions[user_id]
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        response = "–û–ø–µ—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ 2-5 –º–∏–Ω—É—Ç. ‚è∞"
        
        logger.info(f"–û–ø–µ—Ä–∞—Ç–æ—Ä –≤—ã–∑–≤–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Å –ø—Ä–æ–±–ª–µ–º–æ–π: {message}")
        return response
    
    def _is_gibberish(self, text: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤"""
        # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        clean_text = re.sub(r'\s+', '', text)
        
        # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
        if len(clean_text) < 3:
            return True
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∞–∞–∞–∞", "1111")
        if len(set(clean_text)) <= 2 and len(clean_text) > 5:
            return True
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä—É—Å—Å–∫–∏—Ö/–∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö –±—É–∫–≤
        if not re.search(r'[–∞-—è–ê-–Øa-zA-Z]', text):
            return True
            
        return False
        
    def has_active_session(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è –≤—ã–∑–æ–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"""
        return user_id in self.user_sessions
        
    def clear_session(self, user_id: int):
        """–û—á–∏—â–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self.user_sessions:
            del self.user_sessions[user_id]

# –ö–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤
class TicketRecoveryHandler:
    def __init__(self):
        self.user_sessions: Dict[int, Dict] = {}
        
    def start_recovery_session(self, user_id: int):
        """–ù–∞—á–∏–Ω–∞–µ—Ç —Å–µ—Å—Å–∏—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤"""
        self.user_sessions[user_id] = {
            'step': 'waiting_contact_info',
            'data': {},
            'created_at': datetime.now()
        }
        logger.info(f"–ù–∞—á–∞—Ç–∞ —Å–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
    def process_recovery_message(self, user_id: int, message: str) -> Optional[str]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤"""
        if user_id not in self.user_sessions:
            return None
            
        session = self.user_sessions[user_id]
        current_step = session['step']
        
        if current_step == 'waiting_contact_info':
            return self._process_contact_info_step(user_id, message)
            
        return None
        
    def _validate_phone_number(self, phone: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
        clean_phone = re.sub(r'[\s\(\)\-+]', '', phone)
        
        if not clean_phone.startswith(('7', '8')):
            return False
        
        if len(clean_phone) not in [10, 11]:
            return False
        
        if not clean_phone.isdigit():
            return False
        
        patterns = [
            r'^7\d{10}$',
            r'^8\d{10}$',
            r'^7\d{9}$',
            r'^8\d{9}$',
        ]
        
        for pattern in patterns:
            if re.match(pattern, clean_phone):
                return True
        
        return False

    def _validate_email(self, email: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å email"""
        pattern = r'^[a-zA-Z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$'
        return re.match(pattern, email) is not None

    def _extract_contact_info(self, text: str) -> Dict[str, str]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        contacts = {}
        
        # –ò—â–µ–º email
        email_match = re.search(r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b', text)
        if email_match:
            contacts['email'] = email_match.group(0)
        
        # –ò—â–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω (—É–ª—É—á—à–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã)
        phone_patterns = [
            r'\b\+?7\s?\(?\d{3}\)?\s?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}\b',
            r'\b8\s?\(?\d{3}\)?\s?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}\b',
            r'\b7\s?\(?\d{3}\)?\s?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}\b',  # –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è 7 —Å –ø—Ä–æ–±–µ–ª–∞–º–∏
            r'\b7\d{9,10}\b',
            r'\b8\d{9,10}\b',
        ]
        
        found_phones = []
        for pattern in phone_patterns:
            phone_matches = re.finditer(pattern, text)
            for phone_match in phone_matches:
                phone = phone_match.group(0)
                if self._validate_phone_number(phone):
                    found_phones.append(phone)
        
        if found_phones:
            contacts['phone'] = found_phones[0]
        
        # –ò—â–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (6 —Ü–∏—Ñ—Ä)
        order_match = re.search(r'\b(\d{6})\b', text)
        if order_match:
            contacts['order_number'] = order_match.group(1)
        
        return contacts

    def _process_contact_info_step(self, user_id: int, message: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —à–∞–≥ –≤–≤–æ–¥–∞ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"""
        contact_info = self._extract_contact_info(message)
        
        if not contact_info:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø—Ä–æ—Å–∏–º —É—Ç–æ—á–Ω–∏—Ç—å
            return (
                "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ:\n\n"
                "‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (6 —Ü–∏—Ñ—Ä) –ò–õ–ò\n"
                "‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ò–õ–ò\n"
                "‚Ä¢ Email\n\n"
                "–ü—Ä–∏–º–µ—Ä: 123456, +79123456789 –∏–ª–∏ example@mail.ru"
            )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        self.user_sessions[user_id]['data'] = contact_info
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞–¥–µ–∂–∞–º–∏
        found_data = []
        if 'order_number' in contact_info:
            found_data.append(f"–Ω–æ–º–µ—Ä—É –∑–∞–∫–∞–∑–∞: {contact_info['order_number']}")
        if 'phone' in contact_info:
            phone = contact_info['phone']
            clean_phone = re.sub(r'[\s\(\)\-+]', '', phone)
            if clean_phone.startswith('8') and len(clean_phone) == 11:
                formatted_phone = f"+7 ({clean_phone[1:4]}) {clean_phone[4:7]}-{clean_phone[7:9]}-{clean_phone[9:]}"
            elif clean_phone.startswith('7') and len(clean_phone) == 11:
                formatted_phone = f"+7 ({clean_phone[1:4]}) {clean_phone[4:7]}-{clean_phone[7:9]}-{clean_phone[9:]}"
            elif len(clean_phone) == 10:
                formatted_phone = f"+7 ({clean_phone[0:3]}) {clean_phone[3:6]}-{clean_phone[6:8]}-{clean_phone[8:]}"
            else:
                formatted_phone = phone
            found_data.append(f"–Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞: {formatted_phone}")
        if 'email' in contact_info:
            found_data.append(f"email: {contact_info['email']}")
        
        # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–µ—Å—Å–∏—é
        del self.user_sessions[user_id]
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ú –¢–ï–ö–°–¢–û–ú (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞–¥–µ–∂–∏)
        response = (
            f"‚úÖ –ü—Ä–∏–Ω—è—Ç–æ! –ò—â–µ–º –≤–∞—à–∏ –±–∏–ª–µ—Ç—ã –ø–æ {', '.join(found_data)}\n\n"
            "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ —Å–∏—Å—Ç–µ–º–µ...\n\n"
            "–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º:\n"
            "‚Ä¢ –°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–∏–ª–µ—Ç–æ–≤\n"
            "‚Ä¢ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å email-–∞–¥—Ä–µ—Å–∞\n"
            "‚Ä¢ –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏\n\n"
            "‚úÖ –ë–∏–ª–µ—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email –∞–¥—Ä–µ—Å\n"
            "üìß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É ¬´–°–ø–∞–º¬ª, –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–∏—Å—å–º–æ"
        )
        
        logger.info(f"–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –ø–æ –¥–∞–Ω–Ω—ã–º: {contact_info}")
        return response
        
    def has_active_session(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è"""
        return user_id in self.user_sessions
        
    def clear_session(self, user_id: int):
        """–û—á–∏—â–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self.user_sessions:
            del self.user_sessions[user_id]

# –ö–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—à–∏–±–æ—á–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤
class WrongEventRefundHandler:
    def __init__(self):
        self.user_sessions: Dict[int, Dict] = {}
        
    def start_wrong_event_session(self, user_id: int):
        """–ù–∞—á–∏–Ω–∞–µ—Ç —Å–µ—Å—Å–∏—é –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—à–∏–±–æ—á–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤"""
        self.user_sessions[user_id] = {
            'step': 'waiting_order',
            'data': {},
            'created_at': datetime.now()
        }
        logger.info(f"–ù–∞—á–∞—Ç–∞ —Å–µ—Å—Å–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—à–∏–±–æ—á–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
    def process_wrong_event_message(self, user_id: int, message: str) -> Optional[str]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—à–∏–±–æ—á–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤"""
        if user_id not in self.user_sessions:
            return None
            
        session = self.user_sessions[user_id]
        current_step = session['step']
        
        if current_step == 'waiting_order':
            return self._process_order_step(user_id, message)
        elif current_step == 'waiting_contacts':
            return self._process_contacts_step(user_id, message)
            
        return None
        
    def _process_order_step(self, user_id: int, message: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —à–∞–≥ –≤–≤–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞"""
        # –ò—â–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
        order_match = re.search(r'\b(\d{6})\b', message)
        if order_match:
            order_number = order_match.group(1)
            self.user_sessions[user_id]['data']['order_number'] = order_number
            self.user_sessions[user_id]['step'] = 'waiting_contacts'
            
            return (
                f"‚úÖ –ó–∞–∫–∞–∑ ‚Ññ{order_number} –ø—Ä–∏–Ω—è—Ç –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—à–∏–±–æ—á–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤!\n\n"
                "–¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\n\n"
                "‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç)\n"
                "‚Ä¢ Email –¥–ª—è —Å–≤—è–∑–∏\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤:\n"
                "‚Ä¢ 89991234567\n"
                "‚Ä¢ +7 (999) 123-45-67\n"
                "‚Ä¢ 8(999)123-45-67\n\n"
                "–ü—Ä–∏–º–µ—Ä email:\n"
                "‚Ä¢ example@mail.ru\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:"
            )
        else:
            return (
                "–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞!\n\n"
                "–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Ü–∏—Ñ—Ä.\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:"
            )
    
    def _validate_phone_number(self, phone: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
        clean_phone = re.sub(r'[\s\(\)\-+]', '', phone)
        
        if not clean_phone.startswith(('7', '8')):
            return False
        
        if len(clean_phone) not in [10, 11]:
            return False
        
        if not clean_phone.isdigit():
            return False
        
        patterns = [
            r'^7\d{10}$',
            r'^8\d{10}$',
            r'^7\d{9}$',
            r'^8\d{9}$',
        ]
        
        for pattern in patterns:
            if re.match(pattern, clean_phone):
                return True
        
        return False

    def _extract_contact_info(self, text: str) -> Dict[str, str]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        contacts = {}
        
        # –ò—â–µ–º email
        email_match = re.search(r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b', text)
        if email_match:
            contacts['email'] = email_match.group(0)
        
        # –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
        phone_patterns = [
            r'\+7\s?\(?\d{3}\)?\s?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}',  # +7 (999) 123-45-67
            r'8\s?\(?\d{3}\)?\s?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}',   # 8 (999) 123-45-67
            r'7\s?\(?\d{3}\)?\s?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}',   # 7 (999) 123-45-67
            r'\b\d{10,11}\b',                                      # 89991234567
            r'\b\d{1}\s?\d{3}\s?\d{3}\s?\d{2}\s?\d{2}\b',         # 8 999 123 45 67
        ]
        
        found_phones = []
        for pattern in phone_patterns:
            phone_matches = re.finditer(pattern, text)
            for phone_match in phone_matches:
                phone = phone_match.group(0)
                if self._validate_phone_number(phone):
                    found_phones.append(phone)
        
        if found_phones:
            contacts['phone'] = found_phones[0]
        
        return contacts

    def _process_contacts_step(self, user_id: int, message: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —à–∞–≥ –≤–≤–æ–¥–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤"""
        contact_info = self._extract_contact_info(message)
        
        if not contact_info:
            return (
                "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ:\n"
                "‚Ä¢ –†–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (10-11 —Ü–∏—Ñ—Ä)\n"
                "‚Ä¢ –ò–ª–∏ email –∞–¥—Ä–µ—Å\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤:\n"
                "‚Ä¢ 89991234567\n"
                "‚Ä¢ +7 (999) 123-45-67\n"
                "‚Ä¢ 8(999)123-45-67\n\n"
                "–ü—Ä–∏–º–µ—Ä email:\n"
                "‚Ä¢ example@mail.ru\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:"
            )
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        contact_display = []
        if 'phone' in contact_info:
            phone = contact_info['phone']
            clean_phone = re.sub(r'[\s\(\)\-+]', '', phone)
            if clean_phone.startswith('8') and len(clean_phone) == 11:
                formatted_phone = f"+7 ({clean_phone[1:4]}) {clean_phone[4:7]}-{clean_phone[7:9]}-{clean_phone[9:]}"
            elif clean_phone.startswith('7') and len(clean_phone) == 11:
                formatted_phone = f"+7 ({clean_phone[1:4]}) {clean_phone[4:7]}-{clean_phone[7:9]}-{clean_phone[9:]}"
            elif len(clean_phone) == 10:
                formatted_phone = f"+7 ({clean_phone[0:3]}) {clean_phone[3:6]}-{clean_phone[6:8]}-{clean_phone[8:]}"
            else:
                formatted_phone = phone
            contact_display.append(f"–¢–µ–ª–µ—Ñ–æ–Ω: {formatted_phone}")
        
        if 'email' in contact_info:
            contact_display.append(f"Email: {contact_info['email']}")
        
        order_data = self.user_sessions[user_id]['data']
        order_number = order_data.get('order_number', '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        response = (
            "‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–æ—á–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤ –ø—Ä–∏–Ω—è—Ç–∞!\n\n"
            f"–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏:\n"
            f"‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: {order_number}\n"
            f"‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞: –ü–æ–∫—É–ø–∫–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø–æ –æ—à–∏–±–∫–µ\n"
            f"‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {', '.join(contact_display)}\n\n"
            "–ß—Ç–æ –¥–∞–ª—å—à–µ:\n"
            "‚è∞ –û–∂–∏–¥–∞–π—Ç–µ –∑–≤–æ–Ω–∫–∞ –æ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤\n"
            "üìß –ò–ª–∏ –ø–∏—Å—å–º–æ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email\n"
            "üí∞ –í–æ–∑–≤—Ä–∞—Ç –¥–µ–Ω–µ–≥ –∑–∞–π–º–µ—Ç –¥–æ 10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π\n\n"
            "–ü–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤—ã —Å–º–æ–∂–µ—Ç–µ –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã –Ω–∞ –Ω—É–∂–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ!\n\n"
            "–î–ª—è —Å—Ä–æ—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: +7 (999) 123-45-67\n\n"
            "–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å —á–µ–º-—Ç–æ –µ—â–µ?"
        )
        
        # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–µ—Å—Å–∏—é
        del self.user_sessions[user_id]
        logger.info(f"–ó–∞—è–≤–∫–∞ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–æ—á–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞ {order_number}")
        
        return response
        
    def has_active_session(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—é"""
        return user_id in self.user_sessions
        
    def clear_session(self, user_id: int):
        """–û—á–∏—â–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self.user_sessions:
            del self.user_sessions[user_id]

# –ö–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–º–µ–Ω—ã email
class EmailChangeHandler:
    def __init__(self):
        self.user_sessions: Dict[int, Dict] = {}
        
    def start_email_change_session(self, user_id: int):
        """–ù–∞—á–∏–Ω–∞–µ—Ç —Å–µ—Å—Å–∏—é —Å–º–µ–Ω—ã email"""
        self.user_sessions[user_id] = {
            'step': 'waiting_order',
            'data': {},
            'created_at': datetime.now()
        }
        logger.info(f"–ù–∞—á–∞—Ç–∞ —Å–µ—Å—Å–∏—è —Å–º–µ–Ω—ã email –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
    def process_email_change_message(self, user_id: int, message: str) -> Optional[str]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–º–µ–Ω—ã email"""
        if user_id not in self.user_sessions:
            return None
            
        session = self.user_sessions[user_id]
        current_step = session['step']
        
        if current_step == 'waiting_order':
            return self._process_order_step(user_id, message)
        elif current_step == 'waiting_new_email':
            return self._process_email_step(user_id, message)
            
        return None
        
    def _process_order_step(self, user_id: int, message: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —à–∞–≥ –≤–≤–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞"""
        # –ò—â–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
        order_match = re.search(r'\b(\d{6})\b', message)
        if order_match:
            order_number = order_match.group(1)
            self.user_sessions[user_id]['data']['order_number'] = order_number
            self.user_sessions[user_id]['step'] = 'waiting_new_email'
            
            return (
                f"–ó–∞–∫–∞–∑ ‚Ññ{order_number} –ø—Ä–∏–Ω—è—Ç –¥–ª—è —Å–º–µ–Ω—ã email\n\n"
                "–¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –Ω–æ–≤—ã–π email –∞–¥—Ä–µ—Å:\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã:\n"
                "‚Ä¢ example@mail.ru\n"
                "‚Ä¢ myemail@gmail.com\n"
                "‚Ä¢ name@yandex.ru\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π email:"
            )
        else:
            return (
                "–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞!\n\n"
                "–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Ü–∏—Ñ—Ä.\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:"
            )
            
    def _validate_email(self, email: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å email"""
        pattern = r'^[a-zA-Z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$'
        return re.match(pattern, email) is not None
        
    def _process_email_step(self, user_id: int, message: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —à–∞–≥ –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–≥–æ email"""
        email = message.strip()
        
        if not self._validate_email(email):
            return (
                "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email!\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å:\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã:\n"
                "‚Ä¢ example@mail.ru\n"
                "‚Ä¢ myemail@gmail.com\n"
                "‚Ä¢ name@yandex.ru\n\n"
                "–í–≤–µ–¥–∏—Ç–µ email –µ—â–µ —Ä–∞–∑:"
            )
        
        order_data = self.user_sessions[user_id]['data']
        order_number = order_data.get('order_number', '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π email
        self.user_sessions[user_id]['data']['new_email'] = email
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        response = (
            "‚úÖ Email —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!\n\n"
            f"–î–µ—Ç–∞–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è:\n"
            f"‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: {order_number}\n"
            f"‚Ä¢ –ù–æ–≤—ã–π email: {email}\n\n"
            "–ß—Ç–æ –¥–∞–ª—å—à–µ:\n"
            "üìß –ë–∏–ª–µ—Ç—ã –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç\n"
            "üîÑ –°—Ç–∞—Ä—ã–µ –±–∏–ª–µ—Ç—ã (–µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã) —Å—Ç–∞–Ω—É—Ç –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏\n"
            "‚úÖ –ù–æ–≤—ã–µ –±–∏–ª–µ—Ç—ã –ø—Ä–∏–¥—É—Ç –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email\n\n"
            "–ï—Å–ª–∏ –±–∏–ª–µ—Ç—ã –Ω–µ –ø—Ä–∏—à–ª–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç:\n"
            "‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É ¬´–°–ø–∞–º¬ª\n"
            "‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ email\n"
            "‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É\n\n"
            "–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å —á–µ–º-—Ç–æ –µ—â–µ?"
        )
        
        # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–µ—Å—Å–∏—é
        del self.user_sessions[user_id]
        logger.info(f"Email –∏–∑–º–µ–Ω–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–∞ {order_number} –Ω–∞ {email}")
        
        return response
        
    def has_active_session(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è —Å–º–µ–Ω—ã email"""
        return user_id in self.user_sessions
        
    def clear_session(self, user_id: int):
        """–û—á–∏—â–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self.user_sessions:
            del self.user_sessions[user_id]

# –ö–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ–¥–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞
class PartialRefundHandler:
    def __init__(self):
        self.user_sessions: Dict[int, Dict] = {}
        
    def start_partial_refund_session(self, user_id: int):
        """–ù–∞—á–∏–Ω–∞–µ—Ç —Å–µ—Å—Å–∏—é –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ–¥–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞"""
        self.user_sessions[user_id] = {
            'step': 'waiting_ticket_details',
            'data': {},
            'created_at': datetime.now()
        }
        logger.info(f"–ù–∞—á–∞—Ç–∞ —Å–µ—Å—Å–∏—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
    def process_partial_refund_message(self, user_id: int, message: str) -> Optional[str]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞"""
        if user_id not in self.user_sessions:
            return None
            
        session = self.user_sessions[user_id]
        current_step = session['step']
        
        if current_step == 'waiting_ticket_details':
            return self._process_ticket_details_step(user_id, message)
        elif current_step == 'waiting_contacts':
            return self._process_contacts_step(user_id, message)
            
        return None
        
    def _process_ticket_details_step(self, user_id: int, message: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —à–∞–≥ –≤–≤–æ–¥–∞ –¥–µ—Ç–∞–ª–µ–π –±–∏–ª–µ—Ç–∞"""
        # –ò—â–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
        order_match = re.search(r'\b(\d{6})\b', message)
        if order_match:
            order_number = order_match.group(1)
            self.user_sessions[user_id]['data']['order_number'] = order_number
            
            # –ò—â–µ–º –Ω–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ
            ticket_match = re.search(r'(?:–±–∏–ª–µ—Ç|–±–∏–ª–µ—Ç–∞|–Ω–æ–º–µ—Ä)\s*(\d+)', message.lower())
            if ticket_match:
                self.user_sessions[user_id]['data']['ticket_number'] = ticket_match.group(1)
            
            # –ò—â–µ–º –ø—Ä–∏—á–∏–Ω—É
            if '–±–æ–ª–µ–∑–Ω' in message.lower():
                self.user_sessions[user_id]['data']['reason'] = '–ë–æ–ª–µ–∑–Ω—å'
            elif '–∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤' in message.lower():
                self.user_sessions[user_id]['data']['reason'] = '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤'
            elif '–æ—Ç–º–µ–Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è' in message.lower():
                self.user_sessions[user_id]['data']['reason'] = '–û—Ç–º–µ–Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è'
            else:
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–∏—á–∏–Ω—É –∏–∑ —Ç–µ–∫—Å—Ç–∞
                reason_text = self._extract_reason(message)
                if reason_text:
                    self.user_sessions[user_id]['data']['reason'] = reason_text
            
            self.user_sessions[user_id]['step'] = 'waiting_contacts'
            
            response = (
                f"–ó–∞—è–≤–∫–∞ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –æ–¥–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞ –∏–∑ –∑–∞–∫–∞–∑–∞ ‚Ññ{order_number} –ø—Ä–∏–Ω—è—Ç–∞!\n\n"
                "–¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\n\n"
                "‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç)\n"
                "‚Ä¢ Email –¥–ª—è —Å–≤—è–∑–∏\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤:\n"
                "‚Ä¢ 89991234567\n"
                "‚Ä¢ +7 (999) 123-45-67\n"
                "‚Ä¢ 8(999)123-45-67\n\n"
                "–ü—Ä–∏–º–µ—Ä email:\n"
                "‚Ä¢ example@mail.ru"
            )
            return response
        else:
            return (
                "–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞!\n\n"
                "–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Ü–∏—Ñ—Ä.\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:"
            )
    
    def _extract_reason(self, text: str) -> str:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø—Ä–∏—á–∏–Ω—É –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        # –£–±–∏—Ä–∞–µ–º –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–æ–≤ –∏ –±–∏–ª–µ—Ç–æ–≤
        clean_text = re.sub(r'\b\d{6}\b', '', text)
        clean_text = re.sub(r'(?:–±–∏–ª–µ—Ç|–±–∏–ª–µ—Ç–∞|–Ω–æ–º–µ—Ä)\s*\d+', '', text.lower())
        
        # –ò—â–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã
        if '–±–æ–ª–µ–∑–Ω' in clean_text:
            return '–ë–æ–ª–µ–∑–Ω—å'
        elif '–∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤' in clean_text:
            return '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤'
        elif '–æ—Ç–º–µ–Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è' in clean_text:
            return '–û—Ç–º–µ–Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è'
        elif '–æ—à–∏–±–∫' in clean_text:
            return '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ'
        else:
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤ –∫–∞–∫ –ø—Ä–∏—á–∏–Ω—É
            return clean_text.strip()[:50] + "..." if len(clean_text.strip()) > 50 else clean_text.strip()
    
    def _validate_phone_number(self, phone: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
        clean_phone = re.sub(r'[\s\(\)\-+]', '', phone)
        
        if not clean_phone.startswith(('7', '8')):
            return False
        
        if len(clean_phone) not in [10, 11]:
            return False
        
        if not clean_phone.isdigit():
            return False
        
        patterns = [
            r'^7\d{10}$',
            r'^8\d{10}$',
            r'^7\d{9}$',
            r'^8\d{9}$',
        ]
        
        for pattern in patterns:
            if re.match(pattern, clean_phone):
                return True
        
        return False

    def _extract_contact_info(self, text: str) -> Dict[str, str]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        contacts = {}
        
        # –ò—â–µ–º email
        email_match = re.search(r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b', text)
        if email_match:
            contacts['email'] = email_match.group(0)
        
        # –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
        phone_patterns = [
            r'\+7\s?\(?\d{3}\)?\s?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}',  # +7 (999) 123-45-67
            r'8\s?\(?\d{3}\)?\s?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}',   # 8 (999) 123-45-67
            r'7\s?\(?\d{3}\)?\s?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}',   # 7 (999) 123-45-67
            r'\b\d{10,11}\b',                                      # 89991234567
            r'\b\d{1}\s?\d{3}\s?\d{3}\s?\d{2}\s?\d{2}\b',         # 8 999 123 45 67
        ]
        
        found_phones = []
        for pattern in phone_patterns:
            phone_matches = re.finditer(pattern, text)
            for phone_match in phone_matches:
                phone = phone_match.group(0)
                if self._validate_phone_number(phone):
                    found_phones.append(phone)
        
        if found_phones:
            contacts['phone'] = found_phones[0]
        
        return contacts

    def _process_contacts_step(self, user_id: int, message: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —à–∞–≥ –≤–≤–æ–¥–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤"""
        contact_info = self._extract_contact_info(message)
        
        if not contact_info:
            return (
                "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ:\n"
                "‚Ä¢ –†–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (10-11 —Ü–∏—Ñ—Ä)\n"
                "‚Ä¢ –ò–ª–∏ email –∞–¥—Ä–µ—Å\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤:\n"
                "‚Ä¢ 89991234567\n"
                "‚Ä¢ +7 (999) 123-45-67\n"
                "‚Ä¢ 8(999)123-45-67\n\n"
                "–ü—Ä–∏–º–µ—Ä email:\n"
                "‚Ä¢ example@mail.ru\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:"
            )
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        contact_display = []
        if 'phone' in contact_info:
            phone = contact_info['phone']
            clean_phone = re.sub(r'[\s\(\)\-+]', '', phone)
            if clean_phone.startswith('8') and len(clean_phone) == 11:
                formatted_phone = f"+7 ({clean_phone[1:4]}) {clean_phone[4:7]}-{clean_phone[7:9]}-{clean_phone[9:]}"
            elif clean_phone.startswith('7') and len(clean_phone) == 11:
                formatted_phone = f"+7 ({clean_phone[1:4]}) {clean_phone[4:7]}-{clean_phone[7:9]}-{clean_phone[9:]}"
            elif len(clean_phone) == 10:
                formatted_phone = f"+7 ({clean_phone[0:3]}) {clean_phone[3:6]}-{clean_phone[6:8]}-{clean_phone[8:]}"
            else:
                formatted_phone = phone
            contact_display.append(f"–¢–µ–ª–µ—Ñ–æ–Ω: {formatted_phone}")
        
        if 'email' in contact_info:
            contact_display.append(f"Email: {contact_info['email']}")
        
        order_data = self.user_sessions[user_id]['data']
        order_number = order_data.get('order_number', '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')
        ticket_number = order_data.get('ticket_number', '–Ω–µ —É–∫–∞–∑–∞–Ω')
        reason = order_data.get('reason', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        response = (
            "‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –æ–¥–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∞!\n\n"
            f"–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏:\n"
            f"‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: {order_number}\n"
            f"‚Ä¢ –í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π –±–∏–ª–µ—Ç: {ticket_number}\n"
            f"‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞: {reason}\n"
            f"‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {', '.join(contact_display)}\n\n"
            "–ß—Ç–æ –¥–∞–ª—å—à–µ:\n"
            "‚è∞ –û–∂–∏–¥–∞–π—Ç–µ –∑–≤–æ–Ω–∫–∞ –æ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤\n"
            "üìß –ò–ª–∏ –ø–∏—Å—å–º–æ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email\n"
            "üí∞ –í–æ–∑–≤—Ä–∞—Ç –¥–µ–Ω–µ–≥ –∑–∞–π–º–µ—Ç –¥–æ 10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π\n\n"
            "–î–ª—è —Å—Ä–æ—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: +7 (999) 123-45-67\n\n"
            "–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å —á–µ–º-—Ç–æ –µ—â–µ?"
        )
        
        # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–µ—Å—Å–∏—é
        del self.user_sessions[user_id]
        logger.info(f"–ó–∞—è–≤–∫–∞ –Ω–∞ —á–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞ {order_number}")
        
        return response
        
    def has_active_session(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è"""
        return user_id in self.user_sessions
        
    def clear_session(self, user_id: int):
        """–û—á–∏—â–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self.user_sessions:
            del self.user_sessions[user_id]

# –ö–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
class PaymentHandler:
    def __init__(self):
        self.user_sessions: Dict[int, Dict] = {}
        
    def start_payment_session(self, user_id: int):
        """–ù–∞—á–∏–Ω–∞–µ—Ç —Å–µ—Å—Å–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞"""
        self.user_sessions[user_id] = {
            'step': 'waiting_details',
            'data': {},
            'created_at': datetime.now()
        }
        logger.info(f"–ù–∞—á–∞—Ç–∞ —Å–µ—Å—Å–∏—è –æ–ø–ª–∞—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
    def process_payment_message(self, user_id: int, message: str) -> Optional[str]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–ª–∞—Ç–µ–∂–∞"""
        if user_id not in self.user_sessions:
            return None
            
        session = self.user_sessions[user_id]
        
        if session['step'] == 'waiting_details':
            return self._process_payment_details(user_id, message)
            
        return None
        
    def _process_payment_details(self, user_id: int, message: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞"""
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
        data = self._extract_payment_data(message)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
        if 'order_number' in data:
            order_number = data['order_number']
            if len(order_number) != 6 or not order_number.isdigit():
                return "–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞!\n\n–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Ü–∏—Ñ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞."
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        self.user_sessions[user_id]['data'] = data
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö
        has_order = 'order_number' in data
        has_method = 'payment_method' in data
        has_time = 'time_minutes' in data
        
        logger.info(f"–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {data}")
        
        # –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö - –≤—ã–¥–∞–µ–º —Ä–µ—à–µ–Ω–∏–µ
        if has_order and (has_method or has_time):
            response = self._generate_solution_response(data, message, user_id)
            # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–µ—Å—Å–∏—é
            del self.user_sessions[user_id]
            return response
            
        # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ
        return self._request_missing_data(data)
        
    def _extract_payment_data(self, text: str) -> Dict[str, str]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ–± –æ–ø–ª–∞—Ç–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        data = {}
        text_lower = text.lower()
        
        # –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (—Ä–æ–≤–Ω–æ 6 —Ü–∏—Ñ—Ä)
        order_match = re.search(r'\b(\d{6})\b', text)
        if order_match:
            data['order_number'] = order_match.group(1)
            logger.info(f"–ù–∞–π–¥–µ–Ω –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: {data['order_number']}")
        
        # –£–õ–£–ß–®–ï–ù–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –í–†–ï–ú–ï–ù–ò
        time_data = self._extract_time_data(text_lower)
        if time_data:
            data['time_minutes'] = time_data['minutes']
            data['time_description'] = time_data['description']
            logger.info(f"–ù–∞–π–¥–µ–Ω–æ –≤—Ä–µ–º—è: {data['time_description']} = {data['time_minutes']} –º–∏–Ω—É—Ç")
        
        # –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã —Å —É—á–µ—Ç–æ–º –æ–ø–µ—á–∞—Ç–æ–∫
        payment_methods = {
            '–º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ': ['–ø—Ä–∏–ª–æ–∂–µ–Ω', '–ø—Ä–∏–ª–æ–∂–µ–Ω–∏', '–º–æ–±–∏–ª—å–Ω', '—Ç–µ–ª–µ—Ñ–æ–Ω', '–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏', '–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', '–∞–ø–ø', 'app'],
            'QR-–∫–æ–¥': ['qr', '–∫–æ–¥', 'qr-–∫–æ–¥', '–∫—å—é–∞—Ä', '–∫—é–∞—Ä', '–ø–æ qr'],
            '–±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞': ['–∫–∞—Ä—Ç', '–∫–∞—Ä—Ç–æ–π', '–∫–∞—Ä—Ç—É', '–∫–∞—Ä—Ç–∞', '–∫–∞—Ä—Ç–æ—á–∫', '–∫–∞—Ä–¥', 'card']
        }
        
        for method, keywords in payment_methods.items():
            for keyword in keywords:
                if keyword in text_lower:
                    data['payment_method'] = method
                    logger.info(f"–ù–∞–π–¥–µ–Ω —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: {method}")
                    break
            if 'payment_method' in data:
                break
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø—Ä–æ–±–ª–µ–º—ã
        problem_type = self._detect_problem_type(text_lower)
        if problem_type:
            data['problem_type'] = problem_type
        
        return data

    def _detect_problem_type(self, text_lower: str) -> str:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–ø–ª–∞—Ç–æ–π"""
        if any(phrase in text_lower for phrase in ['–¥–≤–∞–∂–¥—ã', '–¥–≤–æ–π–Ω', '–¥–≤–∞ —Ä–∞–∑–∞', '–¥–≤–æ–π–Ω–æ–µ', '–¥–≤–∞–∂–¥—ã', '—Å–ø–∏—Å–∞–ª–∞—Å—å –¥–≤–∞–∂–¥—ã']):
            return 'double_charge'
        elif any(phrase in text_lower for phrase in ['—Å–ø–∏—Å–∞–ª–∏—Å—å', '—Å—Ç–∞—Ç—É—Å –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã', '—Å—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è']):
            return 'money_taken_but_status_pending'
        elif any(phrase in text_lower for phrase in ['—á–µ–∫ –Ω–µ –ø—Ä–∏—à–µ–ª', '–∫–∞—Å—Å–æ–≤—ã–π —á–µ–∫', 'email –Ω–µ –ø—Ä–∏—à–µ–ª']):
            return 'receipt_not_received'
        elif any(phrase in text_lower for phrase in ['–ø–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª', '–¥–µ–Ω—å–≥–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å', '—Å–Ω–∞—á–∞–ª–∞ —Å–ø–∏—Å–∞–ª–∏—Å—å']):
            return 'payment_failed'
        elif any(phrase in text_lower for phrase in ['–æ—à–∏–±–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–ø–ª–∞—Ç—ã', '–Ω–µ –ø–æ–Ω—è—Ç–Ω–æ –ø—Ä–æ—à–µ–ª –ª–∏ –ø–ª–∞—Ç–µ–∂', '–æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ']):
            return 'unclear_status'
        
        return None

    def _extract_time_data(self, text_lower: str) -> Optional[Dict]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç—ã"""
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ß:–ú–ú
        time_match = re.search(r'(\d{1,2}):(\d{2})', text_lower)
        if time_match:
            hour, minute = map(int, time_match.groups())
            now = datetime.now()
            
            # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –æ–ø–ª–∞—Ç–∞ –±—ã–ª–∞ —Å–µ–≥–æ–¥–Ω—è
            payment_time = datetime(now.year, now.month, now.day, hour, minute)
            if payment_time > now:
                # –ï—Å–ª–∏ –≤—Ä–µ–º—è –≤ –±—É–¥—É—â–µ–º, –∑–Ω–∞—á–∏—Ç –≤—á–µ—Ä–∞
                payment_time = payment_time - timedelta(days=1)
            
            time_diff = now - payment_time
            minutes = int(time_diff.total_seconds() / 60)
            
            return {'minutes': str(minutes), 'description': f"—Å–µ–≥–æ–¥–Ω—è –≤ {hour:02d}:{minute:02d}"}
        
        # –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        time_data = self._extract_exact_time(text_lower)
        if time_data:
            return time_data
        
        # –ó–∞—Ç–µ–º –∏—â–µ–º –æ–ø–µ—á–∞—Ç–∫–∏ –∏ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
        time_data = self._extract_approximate_time(text_lower)
        if time_data:
            return time_data
        
        return None

    def _extract_exact_time(self, text_lower: str) -> Optional[Dict]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ—á–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è"""
        # –ú–∏–Ω—É—Ç—ã
        minute_match = re.search(r'(\d+)\s*(?:–º–∏–Ω|–º–∏–Ω—É—Ç|–º–∏–Ω—É—Ç—ã|–º–∏–Ω\.|–º–∏–Ω—É—Ç\.)', text_lower)
        if minute_match:
            minutes = int(minute_match.group(1))
            return {'minutes': str(minutes), 'description': f"{minutes} –º–∏–Ω—É—Ç"}
        
        # –ß–∞—Å—ã
        hour_match = re.search(r'(\d+)\s*(?:—á–∞—Å|—á–∞—Å–∞|—á–∞—Å–æ–≤|—á–∞—Å\.)', text_lower)
        if hour_match:
            hours = int(hour_match.group(1))
            minutes = hours * 60
            hour_word = "—á–∞—Å" if hours == 1 else "—á–∞—Å–∞" if 2 <= hours <= 4 else "—á–∞—Å–æ–≤"
            return {'minutes': str(minutes), 'description': f"{hours} {hour_word}"}
        
        # –î–Ω–∏
        day_match = re.search(r'(\d+)\s*(?:–¥–µ–Ω—å|–¥–Ω—è|–¥–Ω–µ–π|–¥–Ω\.|–¥–µ–Ω—å\.)', text_lower)
        if day_match:
            days = int(day_match.group(1))
            minutes = days * 24 * 60
            day_word = "–¥–µ–Ω—å" if days == 1 else "–¥–Ω—è" if 2 <= days <= 4 else "–¥–Ω–µ–π"
            return {'minutes': str(minutes), 'description': f"{days} {day_word}"}
        
        return None

    def _extract_approximate_time(self, text_lower: str) -> Optional[Dict]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–ø–µ—á–∞—Ç–∫–∏"""
        now = datetime.now()
        
        # –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏
        time_mapping = {
            '—Å–µ–≥–æ–¥–Ω—è': (0, 'day'),  # —Å–µ–≥–æ–¥–Ω—è
            '—Å–µ–¥–Ω—è': (0, 'day'),
            '—Å–µ–≤–æ–¥–Ω—è': (0, 'day'),
            '—Å–µ–≤–æ–Ω—è': (0, 'day'),
            '–≤—á–µ—Ä–∞': (1, 'day'),
            '–≤—á–µ–æ–∞': (1, 'day'),
            '—Ñ—á–µ—Ä–∞': (1, 'day'),
            '–ø–æ–∑–∞–≤—á–µ—Ä–∞': (2, 'day'),
            '–ø–æ–∑–∞–≤—á–µ–∞': (2, 'day'),
            '–ø–æ–∑–∞—Ñ—á–µ—Ä–∞': (2, 'day'),
            '–ø–æ–∑–∞—á–≤–µ—Ä–∞': (2, 'day'),
            '–ø–æ–∑–∞—á–≤–µ—Ä—è': (2, 'day'),
            '–ø–æ–∑–∞—á–≤–µ–∞': (2, 'day'),
            '–Ω–∞ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ': (7, 'day'),
            '–ø—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è': (7, 'day'),
            '–Ω–µ–¥–µ–ª—é –Ω–∞–∑–∞–¥': (7, 'day'),
            '–Ω–µ–¥–µ–ª–∏ –Ω–∞–∑–∞–¥': (7, 'day'),
            '–Ω–µ–¥–µ–ª—è –Ω–∞–∑–∞–¥': (7, 'day'),
        }
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        for phrase, (days_back, unit) in time_mapping.items():
            if phrase in text_lower:
                target_date = now - timedelta(days=days_back)
                description = target_date.strftime("%d.%m.%Y")
                minutes = days_back * 24 * 60
                return {'minutes': str(minutes), 'description': description}
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å—Ç–∏—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–ø–µ—á–∞—Ç–æ–∫
        for phrase, (days_back, unit) in time_mapping.items():
            if self._fuzzy_match(phrase, text_lower):
                target_date = now - timedelta(days=days_back)
                description = target_date.strftime("%d.%m.%Y")
                minutes = days_back * 24 * 60
                return {'minutes': str(minutes), 'description': description}
        
        # –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì
        date_match = re.search(r'(\d{1,2})[\.\-\/](\d{1,2})[\.\-\/](\d{4})', text_lower)
        if date_match:
            try:
                day, month, year = map(int, date_match.groups())
                payment_date = datetime(year, month, day)
                time_diff = now - payment_date
                
                if time_diff.days >= 0:
                    minutes = time_diff.days * 24 * 60
                    description = f"{day:02d}.{month:02d}.{year}"
                    return {'minutes': str(minutes), 'description': description}
            except ValueError:
                pass
        
        return None

    def _fuzzy_match(self, phrase: str, text: str) -> bool:
        """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–µ—á–µ—Ç–∫–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫"""
        # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        words = phrase.split()
        found_words = 0
        
        for word in words:
            if len(word) > 3 and word in text:  # –ò—â–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–∞ –¥–ª–∏–Ω–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤
                found_words += 1
        
        # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –±–æ–ª—å—à–µ –ø–æ–ª–æ–≤–∏–Ω—ã —Å–ª–æ–≤ —Ñ—Ä–∞–∑—ã - —Å—á–∏—Ç–∞–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º
        return found_words >= len(words) // 2
        
    def _generate_solution_response(self, data: Dict, original_message: str, user_id: int) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å —Ä–µ—à–µ–Ω–∏–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã"""
        order_num = data.get('order_number', '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')
        time_mins = data.get('time_minutes', '30')
        time_desc = data.get('time_description', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        payment_method = data.get('payment_method', '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')
        problem_type = data.get('problem_type')
        
        message_lower = original_message.lower()
        
        # –ï—Å–ª–∏ —è–≤–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ —Ç–∏–ø –ø—Ä–æ–±–ª–µ–º—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if not problem_type:
            problem_type = self._detect_problem_type(message_lower)
        
        # –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è - –ø–æ–¥–∫–ª—é—á–∞–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        if detect_need_help(original_message):
            response = (
                f"ü§î –ü–æ –∑–∞–∫–∞–∑—É ‚Ññ{order_num} —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ\n\n"
                "–Ø –≤–∏–∂—É, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Å–æ–≤—Å–µ–º —è—Å–Ω–∞.\n\n"
                "üìû –ü–æ–¥–∫–ª—é—á–∞—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏\n"
                "‚è∞ –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 2-5 –º–∏–Ω—É—Ç\n\n"
                "–û–ø–µ—Ä–∞—Ç–æ—Ä –ø–æ–º–æ–∂–µ—Ç:\n"
                "‚Ä¢ –†–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –≤–∞—à–µ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π\n"
                "‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –≤ —Å–∏—Å—Ç–µ–º–µ\n"
                "‚Ä¢ –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ"
            )
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
            if OPERATOR_CHAT_ID is not None:
                asyncio.create_task(call_operator(
                    types.User(id=user_id, first_name="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", is_bot=False), 
                    f"–ù–µ—è—Å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–ª–∞—Ç–æ–π –∑–∞–∫–∞–∑–∞ {order_num}. –°–æ–æ–±—â–µ–Ω–∏–µ: {original_message}"
                ))
            return response
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø—Ä–æ–±–ª–µ–º—ã –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ—Ç–≤–µ—Ç
        if problem_type == 'double_charge' or any(phrase in message_lower for phrase in ['–¥–≤–∞–∂–¥—ã', '–¥–≤–æ–π–Ω', '–¥–≤–∞ —Ä–∞–∑–∞', '—Å–ø–∏—Å–∞–ª–∞—Å—å –¥–≤–∞–∂–¥—ã']):
            response = (
                f"‚ö†Ô∏è –ü–æ –∑–∞–∫–∞–∑—É ‚Ññ{order_num} –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –¥–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ\n\n"
                "–ü—Ä–æ–±–ª–µ–º–∞: –ü—Ä–æ–∏–∑–æ—à–ª–æ –¥–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤\n\n"
                "üí° –†–µ—à–µ–Ω–∏–µ:\n"
                "‚Ä¢ –û–¥–∏–Ω –∏–∑ –ø–ª–∞—Ç–µ–∂–µ–π –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω\n"
                "‚Ä¢ –í–æ–∑–≤—Ä–∞—Ç –∑–∞–π–º–µ—Ç 3-5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π\n"
                "‚Ä¢ –ë–∏–ª–µ—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã –ø–æ –ø–µ—Ä–≤–æ–º—É —É—Å–ø–µ—à–Ω–æ–º—É –ø–ª–∞—Ç–µ–∂—É\n\n"
                "üìû –î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É\n"
                "‚è∞ –í–æ–∑–≤—Ä–∞—Ç –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –¥–Ω–µ–π"
            )
        
        elif problem_type == 'money_taken_but_status_pending' or any(phrase in message_lower for phrase in ['–¥–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å', '—Å—Ç–∞—Ç—É—Å –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã', '—Å—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è']):
            response = (
                f"‚úÖ –ü–æ –∑–∞–∫–∞–∑—É ‚Ññ{order_num} —Ä–∞–∑–æ–±—Ä–∞–ª—Å—è!\n\n"
                "–ü—Ä–æ–±–ª–µ–º–∞: –î–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å, –Ω–æ —Å—Ç–∞—Ç—É—Å –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è\n\n"
                "üí° –†–µ—à–µ–Ω–∏–µ:\n"
                "‚Ä¢ –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (15-30 –º–∏–Ω—É—Ç)\n"
                "‚Ä¢ –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è\n"
                "‚Ä¢ –ë–∏–ª–µ—Ç—ã –ø—Ä–∏–¥—É—Ç –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞\n\n"
                "‚è∞ –ü–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â–µ 20 –º–∏–Ω—É—Ç\n"
                "üìß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∏ –ø–∞–ø–∫—É ¬´–°–ø–∞–º¬ª\n"
                "üîÑ –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ - –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É"
            )
        
        elif problem_type == 'receipt_not_received' or any(phrase in message_lower for phrase in ['—á–µ–∫ –Ω–µ –ø—Ä–∏—à–µ–ª', '–∫–∞—Å—Å–æ–≤—ã–π —á–µ–∫', 'email –Ω–µ –ø—Ä–∏—à–µ–ª']):
            response = (
                f"üìß –ü–æ –∑–∞–∫–∞–∑—É ‚Ññ{order_num} –ø—Ä–æ–±–ª–µ–º–∞ —Å —á–µ–∫–æ–º\n\n"
                "–ü—Ä–æ–±–ª–µ–º–∞: –ö–∞—Å—Å–æ–≤—ã–π —á–µ–∫ –Ω–µ –ø—Ä–∏—à–µ–ª –Ω–∞ email\n\n"
                "üí° –†–µ—à–µ–Ω–∏–µ:\n"
                "‚Ä¢ –ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç –±–∏–ª–µ—Ç–æ–≤\n"
                "‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É ¬´–°–ø–∞–º¬ª –∏ ¬´–†–∞—Å—Å—ã–ª–∫–∏¬ª\n"
                "‚Ä¢ –ß–µ–∫ –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–æ 2 —á–∞—Å–æ–≤\n\n"
                "üîÑ –ß–µ–∫ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞\n"
                "üìû –ï—Å–ª–∏ –Ω–µ –ø—Ä–∏–¥–µ—Ç - –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É"
            )
        
        elif problem_type == 'payment_failed' or any(phrase in message_lower for phrase in ['–ø–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª', '–¥–µ–Ω—å–≥–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å', '—Å–Ω–∞—á–∞–ª–∞ —Å–ø–∏—Å–∞–ª–∏—Å—å']):
            response = (
                f"üîÑ –ü–æ –∑–∞–∫–∞–∑—É ‚Ññ{order_num} –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø–ª–∞—Ç–µ–∂–æ–º\n\n"
                "–ü—Ä–æ–±–ª–µ–º–∞: –ü–ª–∞—Ç–µ–∂ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –¥–µ–Ω—å–≥–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å\n\n"
                "üí° –†–µ—à–µ–Ω–∏–µ:\n"
                "‚Ä¢ –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ö–æ–ª–¥ (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞) —Å—Ä–µ–¥—Å—Ç–≤\n"
                "‚Ä¢ –î–µ–Ω—å–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤\n"
                "‚Ä¢ –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ 30-60 –º–∏–Ω—É—Ç\n\n"
                "üí≥ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ç –∂–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã\n"
                "‚è∞ –ü–æ–¥–æ–∂–¥–∏—Ç–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–ø–ª–∞—Ç–æ–π"
            )
        
        elif problem_type == 'unclear_status' or any(phrase in message_lower for phrase in ['–æ—à–∏–±–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–ø–ª–∞—Ç—ã', '–Ω–µ –ø–æ–Ω—è—Ç–Ω–æ –ø—Ä–æ—à–µ–ª –ª–∏ –ø–ª–∞—Ç–µ–∂', '–æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ']):
            response = (
                f"‚ùì –ü–æ –∑–∞–∫–∞–∑—É ‚Ññ{order_num} –Ω–µ—è—Å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞\n\n"
                "–ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–ø–æ–Ω—è—Ç–Ω–æ, –ø—Ä–æ—à–µ–ª –ª–∏ –ø–ª–∞—Ç–µ–∂\n\n"
                "üí° –†–µ—à–µ–Ω–∏–µ:\n"
                "‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –±–∞–Ω–∫–æ–≤—Å–∫–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏\n"
                "‚Ä¢ –ü–æ–¥–æ–∂–¥–∏—Ç–µ 15 –º–∏–Ω—É—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞\n"
                "‚Ä¢ –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ - –ø–ª–∞—Ç–µ–∂ –ø—Ä–æ—à–µ–ª\n\n"
                "üì± –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–æ–±–∏–ª—å–Ω–æ–µ –±–∞–Ω–∫–æ–≤—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\n"
                "‚è∞ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç\n"
                "üìû –ï—Å–ª–∏ —Å–æ–º–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è - –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É"
            )
        
        else:
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤
            response = (
                f"‚úÖ –ü–æ –∑–∞–∫–∞–∑—É ‚Ññ{order_num} —Ä–∞–∑–æ–±—Ä–∞–ª—Å—è!\n\n"
                f"‚Ä¢ –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑: {payment_method}\n"
                f"‚Ä¢ –í—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã: {time_desc}\n"
                f"‚Ä¢ –°—Ç–∞—Ç—É—Å: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è\n\n"
                "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n"
                "1Ô∏è‚É£ –ü–æ–¥–æ–∂–¥–∏—Ç–µ 15-20 –º–∏–Ω—É—Ç\n"
                "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∏ –ø–∞–ø–∫—É ¬´–°–ø–∞–º¬ª\n"
                "3Ô∏è‚É£ –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è - –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É\n\n"
                "–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∫–∏: +7 (999) 123-45-67"
            )
        
        return response + "\n\n–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å —á–µ–º-—Ç–æ –µ—â–µ?"
        
    def _request_missing_data(self, data: Dict) -> str:
        """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ"""
        missing = []
        
        if 'order_number' not in data:
            missing.append("–Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (6 —Ü–∏—Ñ—Ä)")
        if 'payment_method' not in data:
            missing.append("—Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã")
        if 'time_minutes' not in data:
            missing.append("–≤—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã")
        
        if missing:
            return (
                "–£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞:\n\n"
                f"–î–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã –Ω—É–∂–µ–Ω {' –∏ '.join(missing)}\n\n"
                "–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞:\n"
                "‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: 123456 (—Ä–æ–≤–Ω–æ 6 —Ü–∏—Ñ—Ä)\n"
                "‚Ä¢ –û–ø–ª–∞—Ç–∏–ª –∫–∞—Ä—Ç–æ–π/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º/QR-–∫–æ–¥–æ–º\n"
                "‚Ä¢ –í—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã: 30 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥, –≤—á–µ—Ä–∞, 25.12.2024"
            )
        
        return "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
        
    def has_active_session(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è"""
        return user_id in self.user_sessions
        
    def clear_session(self, user_id: int):
        """–û—á–∏—â–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self.user_sessions:
            del self.user_sessions[user_id]

# –ö–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
class RefundHandler:
    def __init__(self):
        self.user_sessions: Dict[int, Dict] = {}
        self.refund_requests: Dict[int, Dict] = {}
        
    def start_refund_session(self, user_id: int):
        """–ù–∞—á–∏–Ω–∞–µ—Ç —Å–µ—Å—Å–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞"""
        self.user_sessions[user_id] = {
            'step': 'waiting_order',
            'data': {},
            'created_at': datetime.now()
        }
        logger.info(f"–ù–∞—á–∞—Ç–∞ —Å–µ—Å—Å–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
    def process_refund_message(self, user_id: int, message: str) -> Optional[str]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç–∞"""
        if user_id not in self.user_sessions:
            return None
            
        session = self.user_sessions[user_id]
        current_step = session['step']
        
        if current_step == 'waiting_order':
            return self._process_order_step(user_id, message)
        elif current_step == 'waiting_reason':
            return self._process_reason_step(user_id, message)
        elif current_step == 'waiting_contacts':
            return self._process_contacts_step(user_id, message)
            
        return None
        
    def _process_order_step(self, user_id: int, message: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —à–∞–≥ –≤–≤–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞"""
        # –ò—â–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
        order_match = re.search(r'\b(\d{6})\b', message)
        if order_match:
            order_number = order_match.group(1)
            self.user_sessions[user_id]['data']['order_number'] = order_number
            self.user_sessions[user_id]['step'] = 'waiting_reason'
            
            return (
                "–¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –≤–æ–∑–≤—Ä–∞—Ç–∞:\n\n"
                "‚Ä¢ –ë–æ–ª–µ–∑–Ω—å\n"
                "‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤\n" 
                "‚Ä¢ –û—Ç–º–µ–Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è\n"
                "‚Ä¢ –î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞\n\n"
                "–û–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ, –ø–æ—á–µ–º—É —Ö–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å –±–∏–ª–µ—Ç—ã:"
            )
        else:
            return (
                "–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞!\n\n"
                "–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Ü–∏—Ñ—Ä.\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:"
            )
            
    def _process_reason_step(self, user_id: int, message: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —à–∞–≥ –≤–≤–æ–¥–∞ –ø—Ä–∏—á–∏–Ω—ã"""
        reason = message.strip().lower()
        self.user_sessions[user_id]['data']['reason'] = message
        self.user_sessions[user_id]['step'] = 'waiting_contacts'
        
        # –î–û–ë–ê–í–õ–Ø–ï–ú –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –¢–ï–ö–°–¢ –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –ü–†–ò–ß–ò–ù–´
        additional_text = ""
        
        if '–±–æ–ª–µ–∑–Ω' in reason:
            additional_text = (
                "\n\nüè• –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ –±–æ–ª–µ–∑–Ω–∏:\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ –±–æ–ª–µ–∑–Ω—å, –Ω–∞ –Ω–∞—à—É —Ä–∞–±–æ—á—É—é –ø–æ—á—Ç—É: info@intickets.ru\n\n"
                "–ü–æ–¥—Ö–æ–¥—è—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:\n"
                "‚Ä¢ –°–ø—Ä–∞–≤–∫–∞ –æ—Ç –≤—Ä–∞—á–∞\n"
                "‚Ä¢ –ë–æ–ª—å–Ω–∏—á–Ω—ã–π –ª–∏—Å—Ç\n"
                "‚Ä¢ –í—ã–ø–∏—Å–∫–∞ –∏–∑ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∫–∞—Ä—Ç—ã\n\n"
                "–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –º—ã –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –≤–∞—à –≤–æ–∑–≤—Ä–∞—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤."
            )
        elif '–∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤' in reason:
            additional_text = (
                "\n\nüìÖ –£—Å–ª–æ–≤–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–ª–∞–Ω–æ–≤:\n\n"
                "–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –±–∏–ª–µ—Ç–æ–≤ –¥–µ–π—Å—Ç–≤—É—é—Ç —Å–ª–µ–¥—É—é—â–∏–µ —É—Å–ª–æ–≤–∏—è:\n\n"
                "‚Ä¢ –ú–µ–Ω–µ–µ, —á–µ–º –∑–∞ 3 –¥–Ω—è –¥–æ –Ω–∞—á–∞–ª–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è - –¥–µ–Ω—å–≥–∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è\n"
                "‚Ä¢ –æ—Ç 3 –¥–æ 5 –¥–Ω–µ–π –¥–æ –Ω–∞—á–∞–ª–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 30% —Å—Ç–æ–∏–º–æ—Å—Ç–∏\n"
                "‚Ä¢ –æ—Ç 5 –¥–æ 10 –¥–Ω–µ–π –¥–æ –Ω–∞—á–∞–ª–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 50% —Å—Ç–æ–∏–º–æ—Å—Ç–∏\n"
                "‚Ä¢ –æ—Ç 10 –¥–Ω–µ–π –∏ –±–æ–ª–µ–µ - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 100% —Å—Ç–æ–∏–º–æ—Å—Ç–∏\n\n"
                "–°—Ä–æ–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç –¥–∞—Ç—ã –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è."
            )
        elif '–æ—Ç–º–µ–Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è' in reason:
            additional_text = (
                "\n\n‚ùå –í–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:\n\n"
                "–ï—Å–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ:\n\n"
                "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç:\n"
                "‚Ä¢ –î–µ–Ω—å–≥–∏ –≤–µ—Ä–Ω—É—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç—É, —Å –∫–æ—Ç–æ—Ä–æ–π –±—ã–ª–∞ –æ–ø–ª–∞—Ç–∞, –≤ —Ç–µ—á–µ–Ω–∏–µ 5‚Äì10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.\n"
                "‚Ä¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏–¥–µ—Ç –Ω–∞ –≤–∞—à email.\n"
                "‚Ä¢ –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
            )
        
        return (
            "–¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\n\n"
            "‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç)\n"
            "‚Ä¢ Email –¥–ª—è —Å–≤—è–∑–∏\n\n"
            "–ü—Ä–∏–º–µ—Ä—ã —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤:\n"
            "89991234567\n"
            "+7 (999) 123-45-67\n"
            "8(999)123-45-67\n\n"
            "–ü—Ä–∏–º–µ—Ä email:\n"
            "example@mail.ru" + additional_text
        )
        
    def _validate_phone_number(self, phone: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
        # –û—á–∏—â–∞–µ–º –Ω–æ–º–µ—Ä –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤, —Å–∫–æ–±–æ–∫, –¥–µ—Ñ–∏—Å–æ–≤
        clean_phone = re.sub(r'[\s\(\)\-+]', '', phone)
        
        # –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä
        if not clean_phone.startswith(('7', '8')):
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É (10 –∏–ª–∏ 11 —Ü–∏—Ñ—Ä)
        if len(clean_phone) not in [10, 11]:
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Å–∏–º–≤–æ–ª—ã - —Ü–∏—Ñ—Ä—ã
        if not clean_phone.isdigit():
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã –Ω–æ–º–µ—Ä–æ–≤ –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ
        patterns = [
            r'^7\d{10}$',      # 79991234567 (11 —Ü–∏—Ñ—Ä)
            r'^8\d{10}$',      # 89991234567 (11 —Ü–∏—Ñ—Ä)
            r'^7\d{9}$',       # 7999123456 (10 —Ü–∏—Ñ—Ä)
            r'^8\d{9}$',       # 8999123456 (10 —Ü–∏—Ñ—Ä)
        ]
        
        for pattern in patterns:
            if re.match(pattern, clean_phone):
                return True
        
        return True  # –ë–æ–ª–µ–µ –º—è–≥–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è

    def _extract_contact_info(self, text: str) -> Dict[str, str]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        contacts = {}
        
        # –ò—â–µ–º email
        email_match = re.search(r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b', text)
        if email_match:
            contacts['email'] = email_match.group(0)
        
        # –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
        phone_patterns = [
            r'\+7\s?\(?\d{3}\)?\s?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}',  # +7 (999) 123-45-67
            r'8\s?\(?\d{3}\)?\s?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}',   # 8 (999) 123-45-67
            r'7\s?\(?\d{3}\)?\s?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}',   # 7 (999) 123-45-67
            r'\b\d{10,11}\b',                                      # 89991234567
            r'\b\d{1}\s?\d{3}\s?\d{3}\s?\d{2}\s?\d{2}\b',         # 8 999 123 45 67
        ]
        
        found_phones = []
        for pattern in phone_patterns:
            phone_matches = re.finditer(pattern, text)
            for phone_match in phone_matches:
                phone = phone_match.group(0)
                if self._validate_phone_number(phone):
                    found_phones.append(phone)
        
        # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –≤–∞–ª–∏–¥–Ω—ã–π –Ω–æ–º–µ—Ä
        if found_phones:
            contacts['phone'] = found_phones[0]
        
        return contacts

    def _process_contacts_step(self, user_id: int, message: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —à–∞–≥ –≤–≤–æ–¥–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤"""
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        contact_info = self._extract_contact_info(message)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∞–ª–∏–¥–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç
        if not contact_info:
            return (
                "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ:\n"
                "‚Ä¢ –†–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (10-11 —Ü–∏—Ñ—Ä)\n"
                "‚Ä¢ –ò–ª–∏ email –∞–¥—Ä–µ—Å\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤:\n"
                "‚Ä¢ 89991234567\n"
                "‚Ä¢ +7 (999) 123-45-67\n"
                "‚Ä¢ 8(999)123-45-67\n\n"
                "–ü—Ä–∏–º–µ—Ä email:\n"
                "‚Ä¢ example@mail.ru\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:"
            )
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        contact_display = []
        if 'phone' in contact_info:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            phone = contact_info['phone']
            clean_phone = re.sub(r'[\s\(\)\-+]', '', phone)
            if clean_phone.startswith('8') and len(clean_phone) == 11:
                formatted_phone = f"+7 ({clean_phone[1:4]}) {clean_phone[4:7]}-{clean_phone[7:9]}-{clean_phone[9:]}"
            elif clean_phone.startswith('7') and len(clean_phone) == 11:
                formatted_phone = f"+7 ({clean_phone[1:4]}) {clean_phone[4:7]}-{clean_phone[7:9]}-{clean_phone[9:]}"
            elif len(clean_phone) == 10:
                formatted_phone = f"+7 ({clean_phone[0:3]}) {clean_phone[3:6]}-{clean_phone[6:8]}-{clean_phone[8:]}"
            else:
                formatted_phone = phone
            contact_display.append(f"–¢–µ–ª–µ—Ñ–æ–Ω: {formatted_phone}")
        
        if 'email' in contact_info:
            contact_display.append(f"Email: {contact_info['email']}")
        
        order_data = self.user_sessions[user_id]['data']
        order_number = order_data.get('order_number', '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')
        reason = order_data.get('reason', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞—è–≤–∫—É
        self.refund_requests[user_id] = {
            'order_number': order_number,
            'reason': reason,
            'contacts': contact_info,
            'created_at': datetime.now()
        }
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        response = (
            "–ó–∞—è–≤–∫–∞ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏–Ω—è—Ç–∞!\n\n"
            f"–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏:\n"
            f"‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: {order_number}\n"
            f"‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞: {reason}\n"
            f"‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {', '.join(contact_display)}\n\n"
            "–ß—Ç–æ –¥–∞–ª—å—à–µ:\n"
            "‚è∞ –û–∂–∏–¥–∞–π—Ç–µ –∑–≤–æ–Ω–∫–∞ –æ—Ç –Ω–∞—à–µ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤\n"
            "üìß –ò–ª–∏ –ø–∏—Å—å–º–æ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email\n"
            "üí∞ –í–æ–∑–≤—Ä–∞—Ç –¥–µ–Ω–µ–≥ –∑–∞–π–º–µ—Ç –¥–æ 10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π\n\n"
            "–î–ª—è —Å—Ä–æ—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: +7 (999) 123-45-67\n\n"
            "–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å —á–µ–º-—Ç–æ –µ—â–µ?"
        )
        
        # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–µ—Å—Å–∏—é
        del self.user_sessions[user_id]
        logger.info(f"–ó–∞—è–≤–∫–∞ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞ {order_number}")
        
        return response
        
    def has_active_session(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞"""
        return user_id in self.user_sessions
        
    def clear_session(self, user_id: int):
        """–û—á–∏—â–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self.user_sessions:
            del self.user_sessions[user_id]

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
bot = Bot(
    token=BOT_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)
dp = Dispatcher()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
engine = create_async_engine(config.DATABASE_URL, echo=False)
async_session = sessionmaker(engine, expire_on_commit=False, class_=AsyncSession)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
ds_service = DeepSeekService()
payment_handler = PaymentHandler()
refund_handler = RefundHandler()
email_change_handler = EmailChangeHandler()
partial_refund_handler = PartialRefundHandler()
wrong_event_handler = WrongEventRefundHandler()
operator_handler = OperatorHandler()
ticket_recovery_handler = TicketRecoveryHandler()
order_manager = OrderResponseManager()

# ID –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
OPERATOR_CHAT_ID = config.OPERATOR_CHAT_ID
logger.info(f"OPERATOR_CHAT_ID: {OPERATOR_CHAT_ID}")

# –û—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
def get_main_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üí≥ –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–ª–∞—Ç–æ–π"), KeyboardButton(text="üîÑ –í–æ–∑–≤—Ä–∞—Ç –±–∏–ª–µ—Ç–æ–≤")],
            [KeyboardButton(text="üìß –ë–∏–ª–µ—Ç—ã –Ω–µ –ø—Ä–∏—à–ª–∏/–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"), KeyboardButton(text="üé´ –ö–∞–∫ –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã")],
            [KeyboardButton(text="üÜò –ü–æ–º–æ—â—å"), KeyboardButton(text="üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å")]
        ],
        resize_keyboard=True,
        input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..."
    )

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø–æ–º–æ—â–∏ —Å —á–∞—Å—Ç—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏
def get_help_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º"), KeyboardButton(text="üåê –°–∞–π—Ç Intickets")],
            [KeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥")]
        ],
        resize_keyboard=True,
        input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π..."
    )

async def call_operator(user: types.User, problem_description: str):
    """–í—ã–∑—ã–≤–∞–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ - —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Ö–æ–¥–∏—Ç –¢–û–õ–¨–ö–û –æ–ø–µ—Ä–∞—Ç–æ—Ä—É, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –≤–∏–¥–∏—Ç"""
    try:
        if OPERATOR_CHAT_ID is None:
            logger.info("OPERATOR_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—Ä–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) - –æ–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ —É–≤–µ–¥–æ–º–ª–µ–Ω")
            return
            
        operator_message = (
            f"–¢–†–ï–ë–£–ï–¢–°–Ø –û–ü–ï–†–ê–¢–û–†\n\n"
            f"–ö–ª–∏–µ–Ω—Ç: {user.first_name} {user.last_name or ''} (@{user.username or '–Ω–µ—Ç'})\n"
            f"ID: {user.id}\n"
            f"–ü—Ä–æ–±–ª–µ–º–∞: {problem_description}\n\n"
            f"–í—Ä–µ–º—è: {datetime.now().strftime('%H:%M %d.%m.%Y')}"
        )
        
        await bot.send_message(
            chat_id=OPERATOR_CHAT_ID,
            text=operator_message
        )
        logger.info(f"–û–ø–µ—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω –æ –∫–ª–∏–µ–Ω—Ç–µ {user.id}")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: {e}")

@dp.message(Command("start"))
async def start_command(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    try:
        welcome_text = (
            "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É Intickets!\n\n"
            "–Ø –≤–∞—à AI-–ø–æ–º–æ—â–Ω–∏–∫. –ü–æ–º–æ–≥—É —Å:\n"
            "‚Ä¢ –ü–æ–∫—É–ø–∫–æ–π –∏ –æ–ø–ª–∞—Ç–æ–π –±–∏–ª–µ—Ç–æ–≤\n"
            "‚Ä¢ –í–æ–∑–≤—Ä–∞—Ç–æ–º –±–∏–ª–µ—Ç–æ–≤\n"
            "‚Ä¢ –û—Ç–≤–µ—Ç–∞–º–∏ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã\n\n"
            "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ!\n\n"
            "üîÑ –ß—Ç–æ–±—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /restart –∏–ª–∏ –∫–Ω–æ–ø–∫—É \"üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å\""
        )
        
        await message.answer(welcome_text, reply_markup=get_main_keyboard())
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ start_command: {e}", exc_info=True)

# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–æ–ø—Ä–æ—Å–æ–≤ –æ —Å–µ–±–µ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –±–æ—Ç–∞
@dp.message(F.text.contains("—Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ"))
@dp.message(F.text.contains("—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å"))
@dp.message(F.text.contains("—Ç–≤–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏"))
@dp.message(F.text.contains("–æ —Å–µ–±–µ"))
async def about_bot(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –±–æ—Ç–µ –∏ –µ–≥–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö"""
    about_text = (
        "ü§ñ –û–±–æ –º–Ω–µ:\n\n"
        "–Ø AI-–ø–æ–º–æ—â–Ω–∏–∫ —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Intickets. –í–æ—Ç —á—Ç–æ —è —É–º–µ—é:\n\n"
        "üí≥ **–ü–æ–º–æ—â—å —Å –æ–ø–ª–∞—Ç–æ–π:**\n"
        "‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞\n"
        "‚Ä¢ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –¥–≤–æ–π–Ω—ã–º —Å–ø–∏—Å–∞–Ω–∏–µ–º\n"
        "‚Ä¢ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ–∫–æ–≤\n"
        "‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ —Å–ø–æ—Å–æ–±–∞–º –æ–ø–ª–∞—Ç—ã\n\n"
        "üé´ **–†–∞–±–æ—Ç–∞ —Å –±–∏–ª–µ—Ç–∞–º–∏:**\n"
        "‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞\n"
        "‚Ä¢ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤\n"
        "‚Ä¢ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ email\n"
        "‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –ø–æ–ª—É—á–µ–Ω–∏—é\n\n"
        "üîÑ **–í–æ–∑–≤—Ä–∞—Ç—ã:**\n"
        "‚Ä¢ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –±–∏–ª–µ—Ç–æ–≤\n"
        "‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ —É—Å–ª–æ–≤–∏—è–º –≤–æ–∑–≤—Ä–∞—Ç–∞\n"
        "‚Ä¢ –ü–æ–º–æ—â—å —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º –æ—à–∏–±–æ—á–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫\n"
        "‚Ä¢ –ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç\n\n"
        "üìû **–°–≤—è–∑—å —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º:**\n"
        "‚Ä¢ –ë—ã—Å—Ç—Ä—ã–π –≤—ã–∑–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞\n"
        "‚Ä¢ –ü–æ–º–æ—â—å –≤ —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö\n"
        "‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Å–ª—É—á–∞—è–º\n\n"
        "–Ø –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —É—á—É—Å—å –∏ —É–ª—É—á—à–∞—é—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ–≥–∞—Ç—å –≤–∞–º –ª—É—á—à–µ! ‚ú®"
    )
    await message.answer(about_text, reply_markup=get_main_keyboard())

@dp.message(Command("restart"))
async def restart_command(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /restart - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞"""
    try:
        # –û—á–∏—â–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_id = message.from_user.id
        if payment_handler.has_active_session(user_id):
            payment_handler.clear_session(user_id)
        if refund_handler.has_active_session(user_id):
            refund_handler.clear_session(user_id)
        if email_change_handler.has_active_session(user_id):
            email_change_handler.clear_session(user_id)
        if partial_refund_handler.has_active_session(user_id):
            partial_refund_handler.clear_session(user_id)
        if wrong_event_handler.has_active_session(user_id):
            wrong_event_handler.clear_session(user_id)
        if operator_handler.has_active_session(user_id):
            operator_handler.clear_session(user_id)
        if ticket_recovery_handler.has_active_session(user_id):
            ticket_recovery_handler.clear_session(user_id)
        
        restart_text = (
            "üîÑ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!\n\n"
            "–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –æ—á–∏—â–µ–Ω—ã. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å:"
        )
        
        await message.answer(restart_text, reply_markup=get_main_keyboard())
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ restart_command: {e}", exc_info=True)
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

@dp.message(F.text == "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å")
async def restart_button(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞"""
    try:
        # –û—á–∏—â–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_id = message.from_user.id
        if payment_handler.has_active_session(user_id):
            payment_handler.clear_session(user_id)
        if refund_handler.has_active_session(user_id):
            refund_handler.clear_session(user_id)
        if email_change_handler.has_active_session(user_id):
            email_change_handler.clear_session(user_id)
        if partial_refund_handler.has_active_session(user_id):
            partial_refund_handler.clear_session(user_id)
        if wrong_event_handler.has_active_session(user_id):
            wrong_event_handler.clear_session(user_id)
        if operator_handler.has_active_session(user_id):
            operator_handler.clear_session(user_id)
        if ticket_recovery_handler.has_active_session(user_id):
            ticket_recovery_handler.clear_session(user_id)
        
        restart_text = (
            "üîÑ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!\n\n"
            "–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –æ—á–∏—â–µ–Ω—ã. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å:"
        )
        
        await message.answer(restart_text, reply_markup=get_main_keyboard())
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ restart_button: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

@dp.message(Command("operator"))
async def operator_command(message: types.Message):
    """–ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"""
    try:
        # –ù–∞—á–∏–Ω–∞–µ–º —Å–µ—Å—Å–∏—é –≤—ã–∑–æ–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        operator_handler.start_operator_session(message.from_user.id)
        
        response = (
            "üìû –°–≤—è–∑—å —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–≥ –±—ã—Å—Ç—Ä–µ–µ –≤–∞–º –ø–æ–º–æ—á—å:\n\n"
            "‚Ä¢ –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?\n"
            "‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)\n"
            "‚Ä¢ –ö–∞–∫–∞—è –ø–æ–º–æ—â—å —Ç—Ä–µ–±—É–µ—Ç—Å—è?\n\n"
            "–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º:"
        )
        await message.answer(response, reply_markup=get_main_keyboard())
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –Ω–∞—á–∞–ª –≤—ã–∑–æ–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ operator_command: {e}")
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

@dp.message(F.text == "üí≥ –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–ª–∞—Ç–æ–π")
async def payment_issue_button(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å –æ–ø–ª–∞—Ç–æ–π"""
    try:
        payment_handler.start_payment_session(message.from_user.id)
        
        response = (
            "üí≥ –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–ª–∞—Ç–æ–π\n\n"
            "–ß—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –ø–æ–º–æ—á—å, –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º, —É–∫–∞–∑–∞–≤:\n\n"
            "‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (6 —Ü–∏—Ñ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä: 123456)\n\n"
            "‚Ä¢ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–∫–∞—Ä—Ç–∞/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ/QR-–∫–æ–¥)\n\n"
            "‚Ä¢ –í—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: 30 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥, –≤—á–µ—Ä–∞, 25.12.2024)\n\n"
            "‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:\n"
            "- –î–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å, —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ \"–æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã\"\n"
            "- –î–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∑–∞ –æ–¥–∏–Ω –∑–∞–∫–∞–∑.\n"
            "- –ù–∞ email –Ω–µ –ø—Ä–∏—à–µ–ª –∫–∞—Å—Å–æ–≤—ã–π —á–µ–∫ –∑–∞ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑\n"
            "- –ü–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª, –¥–µ–Ω—å–≥–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –Ω–∞ –∫–∞—Ä—Ç—É \n"
            "- –ù–µ –ø–æ–Ω—è—Ç–Ω–æ, –ø—Ä–æ—à–µ–ª –ª–∏ –ø–ª–∞—Ç–µ–∂.\n"
            "- –î—Ä—É–≥–æ–µ"
        )
        await message.answer(response, reply_markup=get_main_keyboard())
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥ –ø–æ –æ–ø–ª–∞—Ç–µ")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ payment_issue_button: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.")

@dp.message(F.text == "üîÑ –í–æ–∑–≤—Ä–∞—Ç –±–∏–ª–µ—Ç–æ–≤")
async def refund_button(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –±–∏–ª–µ—Ç–æ–≤"""
    try:
        # –û—á–∏—â–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–µ—Å—Å–∏–∏
        user_id = message.from_user.id
        if refund_handler.has_active_session(user_id):
            refund_handler.clear_session(user_id)
        
        # –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
        refund_handler.start_refund_session(user_id)
        
        response = (
            "üîÑ –í–æ–∑–≤—Ä–∞—Ç –±–∏–ª–µ—Ç–æ–≤\n\n"
            "–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —É–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–æ–º–µ—Ä –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞ (6 —Ü–∏—Ñ—Ä).\n\n"
            "–ü—Ä–∏–º–µ—Ä: 456321"
        )
        await message.answer(response, reply_markup=get_main_keyboard())
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –Ω–∞—á–∞–ª –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ refund_button: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.")

@dp.message(F.text == "üìß –ë–∏–ª–µ—Ç—ã –Ω–µ –ø—Ä–∏—à–ª–∏/–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å")
async def tickets_not_received_main(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ë–∏–ª–µ—Ç—ã –Ω–µ –ø—Ä–∏—à–ª–∏/–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é"""
    try:
        # –ù–∞—á–∏–Ω–∞–µ–º —Å–µ—Å—Å–∏—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤
        ticket_recovery_handler.start_recovery_session(message.from_user.id)
        
        response = (
            "üìß –ü—Ä–æ–±–ª–µ–º—ã —Å –±–∏–ª–µ—Ç–∞–º–∏\n\n"
            "üîç –°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–ª–µ—Ç—ã —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ:\n"
            "1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç Intickets.ru\n"
            "2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É –î–ª—è –∑—Ä–∏—Ç–µ–ª–µ–π\n"
            "3. –í–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å —Å–µ—Ä–≤–∏—Å–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤\n\n"
            "---\n\n"
            "üîÑ –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–ª–µ—Ç—ã:\n"
            "–î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–∏–ª–µ—Ç–æ–≤ —É–∫–∞–∂–∏—Ç–µ:\n\n"
            "‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (6 —Ü–∏—Ñ—Ä) –ò–õ–ò\n"
            "‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –ò–õ–ò\n"
            "‚Ä¢ Email, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫—É–ø–∞–ª–∏ –±–∏–ª–µ—Ç—ã\n\n"
            "‚úÖ –ü—Ä–∏–º–µ—Ä –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞: 123456\n"
            "‚úÖ –ü—Ä–∏–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: +7 (912) 345-67-89\n"
            "‚úÖ –ü—Ä–∏–º–µ—Ä email: example@mail.ru\n\n"
            "–ë–∏–ª–µ—Ç—ã –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç!"
        )
        await message.answer(response, reply_markup=get_main_keyboard())
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –Ω–∞—á–∞–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ tickets_not_received_main: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.")

@dp.message(F.text == "üé´ –ö–∞–∫ –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã")
async def how_to_buy_tickets_main(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ö–∞–∫ –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã' –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é"""
    response = (
        "üé´ –ö–∞–∫ –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã:\n\n"
        "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç –Ω–∞—à–∏—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ (–¢–µ–∞—Ç—Ä –ú–æ—Å—Å–æ–≤–µ—Ç–∞, –°—Ñ–µ—Ä–∞ –∏ –¥—Ä.)\n"
        "2. –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∏ –¥–∞—Ç—É\n"
        "3. –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–∞ –≤ –∑–∞–ª–µ\n"
        "4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤\n"
        "5. –û–ø–ª–∞—Ç–∏—Ç–µ –∑–∞–∫–∞–∑ –∫–∞—Ä—Ç–æ–π –∏–ª–∏ –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º\n"
        "6. –ë–∏–ª–µ—Ç—ã –ø—Ä–∏–¥—É—Ç –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email\n\n"
        "–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–ø–ª–∞—Ç–æ–π –∏–ª–∏ –±–∏–ª–µ—Ç—ã –Ω–µ –ø—Ä–∏—à–ª–∏ - –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å!"
    )
    await message.answer(response, reply_markup=get_main_keyboard())

@dp.message(F.text == "üÜò –ü–æ–º–æ—â—å")
async def help_button(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ–º–æ—â–∏"""
    try:
        response = (
            "üÜò –ü–æ–º–æ—â—å\n\n"
            "–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ —Ä–∞–∑–¥–µ–ª—ã:\n\n"
            "üí≥ –ü—Ä–æ–±–ª–µ–º—ã —Å –æ–ø–ª–∞—Ç–æ–π - –ø–æ–º–æ—â—å —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏\n"
            "üîÑ –í–æ–∑–≤—Ä–∞—Ç –±–∏–ª–µ—Ç–æ–≤ - —É—Å–ª–æ–≤–∏—è –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞\n"
            "üìß –ë–∏–ª–µ—Ç—ã –Ω–µ –ø—Ä–∏—à–ª–∏/–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å - —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π\n"
            "üé´ –ö–∞–∫ –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–∫—É–ø–∫–µ\n\n"
            "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏:\n"
            "üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º - —Å–≤—è–∑—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º\n"
            "üåê –°–∞–π—Ç Intickets - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã\n"
            "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å - –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å!"
        )
        await message.answer(response, reply_markup=get_help_keyboard())
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–º–æ—â—å")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ help_button: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–æ–º–æ—â–∏
@dp.message(F.text == "üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º")
async def operator_from_help(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–∑–æ–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏–∑ –º–µ–Ω—é –ø–æ–º–æ—â–∏"""
    try:
        # –ù–∞—á–∏–Ω–∞–µ–º —Å–µ—Å—Å–∏—é –≤—ã–∑–æ–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        operator_handler.start_operator_session(message.from_user.id)
        
        response = (
            "üìû –°–≤—è–∑—å —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–≥ –±—ã—Å—Ç—Ä–µ–µ –≤–∞–º –ø–æ–º–æ—á—å:\n\n"
            "‚Ä¢ –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?\n"
            "‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)\n"
            "‚Ä¢ –ö–∞–∫–∞—è –ø–æ–º–æ—â—å —Ç—Ä–µ–±—É–µ—Ç—Å—è?\n\n"
            "–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º:"
        )
        await message.answer(response, reply_markup=get_help_keyboard())
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –Ω–∞—á–∞–ª –≤—ã–∑–æ–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏–∑ –º–µ–Ω—é –ø–æ–º–æ—â–∏")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ operator_from_help: {e}")
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

@dp.message(F.text == "üåê –°–∞–π—Ç Intickets")
async def website_from_help(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–∞–π—Ç–∞ –∏–∑ –º–µ–Ω—é –ø–æ–º–æ—â–∏"""
    try:
        response = (
            "üåê –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã Intickets:\n\n"
            "‚Ä¢ –û—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç: https://intickets.ru\n"
            "‚Ä¢ FAQ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏: https://intickets.ru/faq\n"
            "‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞: support@intickets.ru\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å!"
        )
        await message.answer(response, reply_markup=get_help_keyboard())
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∞–π—Ç –∏–∑ –ø–æ–º–æ—â–∏")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ website_from_help: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.")

@dp.message(F.text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥")
async def back_to_main(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥"""
    try:
        response = "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
        await message.answer(response, reply_markup=get_main_keyboard())
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –≤–µ—Ä–Ω—É–ª—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ back_to_main: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

@dp.message()
async def handle_all_messages(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–µ–∫—Å—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)"""
    try:
        logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {message.from_user.id}: {message.text}")
        
        user_id = message.from_user.id
        message_text = message.text.lower()
        
        # 0. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –≤—ã–∑–æ–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (–í–´–°–®–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)
        if operator_handler.has_active_session(user_id):
            operator_response = operator_handler.process_operator_message(user_id, message.text)
            if operator_response:
                await message.answer(operator_response, reply_markup=get_main_keyboard())
                return

        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤
        if ticket_recovery_handler.has_active_session(user_id):
            recovery_response = ticket_recovery_handler.process_recovery_message(user_id, message.text)
            if recovery_response:
                await message.answer(recovery_response, reply_markup=get_main_keyboard())
                return
            else:
                # –ï—Å–ª–∏ –≤ —Å–µ—Å—Å–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ, –ø—Ä–æ—Å–∏–º —É—Ç–æ—á–Ω–∏—Ç—å
                response = (
                    "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ:\n\n"
                    "‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (6 —Ü–∏—Ñ—Ä) –ò–õ–ò\n"
                    "‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ò–õ–ò\n"
                    "‚Ä¢ Email\n\n"
                    "–ü—Ä–∏–º–µ—Ä: 123456, +79123456789 –∏–ª–∏ example@mail.ru"
                )
                await message.answer(response, reply_markup=get_main_keyboard())
                return

        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—à–∏–±–æ—á–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤
        if wrong_event_handler.has_active_session(user_id):
            wrong_event_response = wrong_event_handler.process_wrong_event_message(user_id, message.text)
            if wrong_event_response:
                await message.answer(wrong_event_response, reply_markup=get_main_keyboard())
                return

        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —Å–º–µ–Ω—ã email
        if email_change_handler.has_active_session(user_id):
            email_response = email_change_handler.process_email_change_message(user_id, message.text)
            if email_response:
                await message.answer(email_response, reply_markup=get_main_keyboard())
                return

        # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞
        if partial_refund_handler.has_active_session(user_id):
            partial_refund_response = partial_refund_handler.process_partial_refund_message(user_id, message.text)
            if partial_refund_response:
                await message.answer(partial_refund_response, reply_markup=get_main_keyboard())
                return

        # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
        if refund_handler.has_active_session(user_id):
            refund_response = refund_handler.process_refund_message(user_id, message.text)
            if refund_response:
                await message.answer(refund_response, reply_markup=get_main_keyboard())
                return
        
        # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –æ–ø–ª–∞—Ç—ã
        if payment_handler.has_active_session(user_id):
            payment_response = payment_handler.process_payment_message(user_id, message.text)
            if payment_response:
                await message.answer(payment_response, reply_markup=get_main_keyboard())
                return
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç"
        await message.bot.send_chat_action(chat_id=message.chat.id, action="typing")
        
        # 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ç–∑—ã–≤—ã (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)
        if detect_thanks_and_praise(message.text):
            logger.info(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            thanks_responses = [
                "–û–≥–æ, —Å–ø–∞—Å–∏–±–æ –∑–∞ —Ç–∞–∫–∏–µ —Ç–µ–ø–ª—ã–µ —Å–ª–æ–≤–∞! üòä –û—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ —Å–ª—ã—à–∞—Ç—å! –†–∞–¥, —á—Ç–æ —Å–º–æ–≥ –ø–æ–º–æ—á—å!",
                "–í–∞—É, —Å–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç! ü§ó –≠—Ç–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –µ—â–µ –ª—É—á—à–µ!",
                "–û—Ñ–∏–≥–µ–Ω–Ω–æ! –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤! üéâ –†–∞–¥, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –Ω–∞–¥–æ!",
                "–ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –¥–æ–±—Ä—ã–µ —Å–ª–æ–≤–∞! üòá –û—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ –ø–æ–º–æ–≥–∞—Ç—å —Ç–∞–∫–∏–º –æ—Ç–∑—ã–≤—á–∏–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!",
                "–°–ø–∞—Å–∏–±–æ! –í—ã –¥–µ–ª–∞–µ—Ç–µ –º–æ–π –¥–µ–Ω—å –ª—É—á—à–µ! ‚ú® –†–∞–¥, —á—Ç–æ —Å–º–æ–≥ –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω!",
                "–í–∞—É, –∫–∞–∫ –ø—Ä–∏—è—Ç–Ω–æ! –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å! üåü –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!",
                "–û–≥—Ä–æ–º–Ω–æ–µ —Å–ø–∞—Å–∏–±–æ! –¢–∞–∫–∏–µ —Å–ª–æ–≤–∞ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—Ç –Ω–∞ –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—à–µ–Ω–∏—è! üöÄ",
                "–ë–ª–∞–≥–æ–¥–∞—Ä—é! –û—á–µ–Ω—å —Ä–∞–¥, —á—Ç–æ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å! üòé –ë—É–¥—É –∏ –¥–∞–ª—å—à–µ —Å—Ç–∞—Ä–∞—Ç—å—Å—è!",
                "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤—ã—Å–æ–∫—É—é –æ—Ü–µ–Ω–∫—É! üí´ –≠—Ç–æ –ª—É—á—à–∞—è –Ω–∞–≥—Ä–∞–¥–∞ –¥–ª—è –º–µ–Ω—è!",
                "–í–∞—É, —è —Ä–∞—Å—Ç—Ä–æ–≥–∞–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–∞–∫–∏–µ —Å–ª–æ–≤–∞! ü•∞ –ë—É–¥—É –∏ –¥–∞–ª—å—à–µ –ø–æ–º–æ–≥–∞—Ç—å!"
            ]
            response = random.choice(thanks_responses)
            await message.answer(response, reply_markup=get_main_keyboard())
            return
        
        # 8. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ
        if detect_dissatisfaction_improved(message.text):
            logger.info(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            response = "–ü–æ–Ω–∏–º–∞—é –≤–∞—à–µ –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ. –°–µ–π—á–∞—Å –ø–æ–¥–∫–ª—é—á—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞!"
            await message.answer(response, reply_markup=get_main_keyboard())
            
            if OPERATOR_CHAT_ID is not None:
                asyncio.create_task(call_operator(message.from_user, f"–ù–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ: {message.text}"))
            return
        
        # 9. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å–∞–º
        if detect_need_help(message.text):
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å–∞–º - –ø–æ–¥–∫–ª—é—á–∞–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞")
            response = (
                "–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ –≤–∞–º —Å–ª–æ–∂–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ!\n\n"
                "üìû –ü–æ–¥–∫–ª—é—á–∞—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–º–æ—â–∏\n"
                "‚è∞ –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 2-5 –º–∏–Ω—É—Ç\n\n"
                "–û–ø–µ—Ä–∞—Ç–æ—Ä –ø–æ–º–æ–∂–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –≤–∞—à–µ–π –ø—Ä–æ–±–ª–µ–º–æ–π –∏ –Ω–∞–π–¥–µ—Ç —Ä–µ—à–µ–Ω–∏–µ!"
            )
            await message.answer(response, reply_markup=get_main_keyboard())
            
            if OPERATOR_CHAT_ID is not None:
                asyncio.create_task(call_operator(message.from_user, f"–ù–µ –º–æ–∂–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è: {message.text}"))
            return
        
        # 10. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—â–∞–Ω–∏–µ –∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å
        farewell_words = ['–Ω–µ—Ç', '–Ω–µ—Ç —Å–ø–∞—Å–∏–±–æ', '–Ω–µ –Ω–∞–¥–æ', '–≤—Å—ë', '–≤—Å–µ–≥–æ —Ö–æ—Ä–æ—à–µ–≥–æ', 
                         '–ø–æ–∫–∞', '–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è', '—Å–ø–∞—Å–∏–±–æ –Ω–µ—Ç', '–Ω–µ –Ω—É–∂–Ω–æ', '–∑–∞–∫–æ–Ω—á–∏–ª–∏']
        if message_text in farewell_words:
            farewell_responses = [
                "–•–æ—Ä–æ—à–æ! –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã - –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å! –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è! üëã",
                "–ü–æ–Ω—è–ª! –ë—É–¥—É —Ä–∞–¥ –ø–æ–º–æ—á—å —Å–Ω–æ–≤–∞, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è. –í—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ! üòä",
                "–Ø—Å–Ω–æ! –ù–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –æ–±—Ä–∞—â–∞—Ç—å—Å—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è! üëç",
                "–û–∫–µ–π! –ñ–µ–ª–∞—é —É–¥–∞—á–Ω–æ–≥–æ –¥–Ω—è! –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è - —è –∑–¥–µ—Å—å ü§ó"
            ]
            response = random.choice(farewell_responses)
            await message.answer(response, reply_markup=get_main_keyboard())
            return
        
        # 11. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        positive_words = ['–¥–∞', '–¥–∞–≤–∞–π', '–∫–æ–Ω–µ—á–Ω–æ', '—Ö–æ—á—É', '–Ω—É–∂–Ω–æ', '–ø–æ–º–æ–≥–∏', '–ø–æ–º–æ—â—å –Ω—É–∂–Ω–∞']
        if message_text in positive_words:
            positive_responses = [
                "–û—Ç–ª–∏—á–Ω–æ! –ß–µ–º –µ—â–µ –º–æ–≥—É –ø–æ–º–æ—á—å? –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å! üòä",
                "–†–∞–¥ –ø–æ–º–æ—á—å! –ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? –ú–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏–ª–∏ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å! üëç",
                "–•–æ—Ä–æ—à–æ! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —Å —á–µ–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å? –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å! ü§ó",
                "–û—Ç–ª–∏—á–Ω–æ! –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω? –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É! üí´"
            ]
            response = random.choice(positive_responses)
            await message.answer(response, reply_markup=get_main_keyboard())
            return
        
        # 12. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ–∫—É–ø–∫–µ –±–∏–ª–µ—Ç–æ–≤
        purchase_patterns = [
            '–∫–∞–∫ –∫—É–ø–∏—Ç—å', '–∫–∞–∫ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏', '–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–∫—É–ø–∫–∏', '–∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑',
            '—Ö–æ—á—É –∫—É–ø–∏—Ç—å', '—Ö–æ—á—É –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏', '–∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç', '–ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –±–∏–ª–µ—Ç',
            '–∫–∞–∫ –∑–∞–∫–∞–∑–∞—Ç—å', '–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑', '–∫–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å –±–∏–ª–µ—Ç', '–ø—Ä–æ—Ü–µ—Å—Å –ø–æ–∫—É–ø–∫–∏',
            '–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–∫—É–ø–∫–µ', '–∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –±–∏–ª–µ—Ç', '–∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –±–∏–ª–µ—Ç'
        ]

        if any(phrase in message_text for phrase in purchase_patterns):
            response = (
                "üé´ –ö–∞–∫ –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã:\n\n"
                "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç –Ω–∞—à–∏—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ (–¢–µ–∞—Ç—Ä –ú–æ—Å—Å–æ–≤–µ—Ç–∞, –°—Ñ–µ—Ä–∞ –∏ –¥—Ä.)\n"
                "2. –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∏ –¥–∞—Ç—É\n"
                "3. –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–∞ –≤ –∑–∞–ª–µ\n"
                "4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤\n"
                "5. –û–ø–ª–∞—Ç–∏—Ç–µ –∑–∞–∫–∞–∑ –∫–∞—Ä—Ç–æ–π –∏–ª–∏ –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º\n"
                "6. –ë–∏–ª–µ—Ç—ã –ø—Ä–∏–¥—É—Ç –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email\n\n"
                "–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–ø–ª–∞—Ç–∞ –∏–ª–∏ –±–∏–ª–µ—Ç—ã –Ω–µ –ø—Ä–∏—à–ª–∏ - –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å!"
            )
            await message.answer(response, reply_markup=get_main_keyboard())
            return
        
        # 13. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –í–ê–†–ò–ê–ù–¢
        payment_keywords = ['–æ–ø–ª–∞—Ç', '–ø–ª–∞—Ç–µ–∂', '–¥–µ–Ω—å–≥–∏', '–∫–∞—Ä—Ç', '–ø—Ä–∏–ª–æ–∂–µ–Ω', 'qr', '—á–µ–∫', '—Å–ø–∏—Å–∞–ª–∏—Å—å']
        if any(keyword in message_text for keyword in payment_keywords):
            # –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ - —Å–æ–∑–¥–∞–µ–º
            if not payment_handler.has_active_session(user_id):
                payment_handler.start_payment_session(user_id)
            
            # –°—Ä–∞–∑—É –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ payment_handler
            payment_response = payment_handler.process_payment_message(user_id, message.text)
            if payment_response:
                await message.answer(payment_response, reply_markup=get_main_keyboard())
                return
            else:
                # –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç (–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                response = (
                    "üí≥ –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–ª–∞—Ç–æ–π\n\n"
                    "–ß—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –ø–æ–º–æ—á—å, –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º, —É–∫–∞–∑–∞–≤:\n\n"
                    "‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (6 —Ü–∏—Ñ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä: 123456)\n\n"
                    "‚Ä¢ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–∫–∞—Ä—Ç–∞/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ/QR-–∫–æ–¥)\n\n"
                    "‚Ä¢ –í—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: 30 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥, –≤—á–µ—Ä–∞, 25.12.2024)\n\n"
                    "‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:\n"
                    "- –î–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å, —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ \"–æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã\"\n"
                    "- –î–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∑–∞ –æ–¥–∏–Ω –∑–∞–∫–∞–∑.\n"
                    "- –ù–∞ email –Ω–µ –ø—Ä–∏—à–µ–ª –∫–∞—Å—Å–æ–≤—ã–π —á–µ–∫ –∑–∞ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑\n"
                    "- –ü–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª, –¥–µ–Ω—å–≥–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –Ω–∞ –∫–∞—Ä—Ç—É \n"
                    "- –ù–µ –ø–æ–Ω—è—Ç–Ω–æ, –ø—Ä–æ—à–µ–ª –ª–∏ –ø–ª–∞—Ç–µ–∂.\n"
                    "- –î—Ä—É–≥–æ–µ"
                )
                await message.answer(response, reply_markup=get_main_keyboard())
                return
        
        # 14. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–ø—Ä–æ—Å—ã –æ –≤–æ–∑–≤—Ä–∞—Ç–µ –±–∏–ª–µ—Ç–æ–≤ –ø–æ —Ç–µ–∫—Å—Ç—É
        if any(phrase in message_text for phrase in ['–≤–æ–∑–≤—Ä–∞—Ç', '–≤–µ—Ä–Ω—É—Ç—å', '–≤–µ—Ä–Ω—É–ª']):
            refund_handler.start_refund_session(user_id)
            response = (
                "üîÑ –í–æ–∑–≤—Ä–∞—Ç –±–∏–ª–µ—Ç–æ–≤\n\n"
                "–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —É–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–æ–º–µ—Ä –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞ (6 —Ü–∏—Ñ—Ä).\n\n"
                "–ü—Ä–∏–º–µ—Ä: 456321"
            )
            await message.answer(response, reply_markup=get_main_keyboard())
            return
        
        # 15. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ–∫—É–ø–∫–µ –Ω–∞ –¥—Ä—É–≥–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø–æ –æ—à–∏–±–∫–µ
        if any(phrase in message_text for phrase in ['–∫—É–ø–∏–ª –ø–æ –æ—à–∏–±–∫–µ', '–Ω–µ —Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', '–æ—à–∏–±–æ—á–Ω–æ –∫—É–ø–∏–ª', 
                                                   '–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–±—Ä–∞–ª', '–ø–µ—Ä–µ–ø—É—Ç–∞–ª –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', 
                                                   '–¥—Ä—É–≥–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø–æ –æ—à–∏–±–∫–µ']):
            logger.info(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω –≤–æ–ø—Ä–æ—Å –æ –ø–æ–∫—É–ø–∫–µ –Ω–∞ –¥—Ä—É–≥–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            
            # –ù–∞—á–∏–Ω–∞–µ–º —Å–µ—Å—Å–∏—é –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—à–∏–±–æ—á–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤
            wrong_event_handler.start_wrong_event_session(user_id)
            
            response = (
                "üîÑ –ü–æ–∫—É–ø–∫–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø–æ –æ—à–∏–±–∫–µ\n\n"
                "–ü–æ–Ω–∏–º–∞—é —Å–∏—Ç—É–∞—Ü–∏—é! –í–æ—Ç —á—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:\n\n"
                "‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 1 - –í–æ–∑–≤—Ä–∞—Ç –∏ –Ω–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞:\n"
                "1. –û—Ñ–æ—Ä–º–∏—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–æ—á–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤\n"
                "2. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞\n"
                "3. –ö—É–ø–∏—Ç–µ –±–∏–ª–µ—Ç—ã –Ω–∞ –Ω—É–∂–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ\n\n"
                "‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 2 - –û–±–º–µ–Ω —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:\n"
                "‚Ä¢ –ü–æ–¥–∫–ª—é—á—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞\n"
                "‚Ä¢ –í–æ–∑–º–æ–∂–µ–Ω –æ–±–º–µ–Ω –Ω–∞ –¥—Ä—É–≥–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ\n"
                "‚Ä¢ –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç\n\n"
                "–†–µ–∫–æ–º–µ–Ω–¥—É—é –æ—Ñ–æ—Ä–º–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç:\n"
                "‚Ä¢ –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (6 —Ü–∏—Ñ—Ä)\n"
                "‚Ä¢ –ó–∞—Ç–µ–º —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:"
            )
            await message.answer(response, reply_markup=get_main_keyboard())
            return

        # 16. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–ø—Ä–æ—Å—ã –æ –≤–æ–∑–≤—Ä–∞—Ç–µ –æ–¥–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞
        if any(phrase in message_text for phrase in ['–≤–µ—Ä–Ω—É—Ç—å –æ–¥–∏–Ω –±–∏–ª–µ—Ç', '—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –±–∏–ª–µ—Ç', '–æ–¥–∏–Ω –∏–∑ –∑–∞–∫–∞–∑–∞', 
                                                   '—á–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç', '–Ω–µ –≤—Å–µ –±–∏–ª–µ—Ç—ã']):
            logger.info(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω –≤–æ–ø—Ä–æ—Å –æ –≤–æ–∑–≤—Ä–∞—Ç–µ –æ–¥–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            
            # –ù–∞—á–∏–Ω–∞–µ–º —Å–µ—Å—Å–∏—é —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞
            partial_refund_handler.start_partial_refund_session(user_id)
            
            response = (
                "üîÑ –í–æ–∑–≤—Ä–∞—Ç –æ–¥–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞ –∏–∑ –∑–∞–∫–∞–∑–∞\n\n"
                "–î–∞, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –±–∏–ª–µ—Ç –∏–∑ –∑–∞–∫–∞–∑–∞!\n\n"
                "–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —É–∫–∞–∂–∏—Ç–µ:\n\n"
                "1Ô∏è‚É£ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (6 —Ü–∏—Ñ—Ä)\n"
                "2Ô∏è‚É£ –ù–æ–º–µ—Ä –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –±–∏–ª–µ—Ç–∞\n"
                "3Ô∏è‚É£ –ü—Ä–∏—á–∏–Ω—É –≤–æ–∑–≤—Ä–∞—Ç–∞\n\n"
                "–ü—Ä–∏–º–µ—Ä:\n"
                "–ó–∞–∫–∞–∑ 123456, –±–∏–ª–µ—Ç 323243, –ø–æ –±–æ–ª–µ–∑–Ω–∏\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:"
            )
            await message.answer(response, reply_markup=get_main_keyboard())
            return

        # 17. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–ø—Ä–æ—Å—ã –æ —Å–º–µ–Ω–µ email
        if any(phrase in message_text for phrase in ['–∏–∑–º–µ–Ω–∏—Ç—å email', '–ø–æ–º–µ–Ω—è—Ç—å email', '—Å–º–µ–Ω–∏—Ç—å –ø–æ—á—Ç—É', 
                                                   '–¥—Ä—É–≥–æ–π email', '–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π email']):
            logger.info(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω –≤–æ–ø—Ä–æ—Å –æ —Å–º–µ–Ω–µ email —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            
            # –ù–∞—á–∏–Ω–∞–µ–º —Å–µ—Å—Å–∏—é —Å–º–µ–Ω—ã email
            email_change_handler.start_email_change_session(user_id)
            
            response = (
                "üìß –ò–∑–º–µ–Ω–µ–Ω–∏–µ email –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤\n\n"
                "–î–∞, –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å email!\n\n"
                "–î–ª—è —Å–º–µ–Ω—ã email —É–∫–∞–∂–∏—Ç–µ:\n\n"
                "1Ô∏è‚É£ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (6 —Ü–∏—Ñ—Ä)\n"
                "2Ô∏è‚É£ –ù–æ–≤—ã–π email –∞–¥—Ä–µ—Å\n\n"
                "–ü—Ä–∏–º–µ—Ä:\n"
                "–ó–∞–∫–∞–∑ 123456, –Ω–æ–≤—ã–π email example@mail.ru\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:"
            )
            await message.answer(response, reply_markup=get_main_keyboard())
            return

        # 18. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–±–ª–µ–º—ã —Å –±–∏–ª–µ—Ç–∞–º–∏ (–æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞) - –†–ê–°–®–ò–†–ï–ù–ù–´–ô –ü–û–ò–°–ö
        ticket_problem_patterns = [
            r'–Ω–µ\s*–ø—Ä–∏—à–ª–∏',
            r'–Ω–µ\s*–ø—Ä–∏—à—ë–ª',
            r'–Ω–µ\s*–ø—Ä–∏—à–µ–ª',
            r'–Ω–µ\s*–ø–æ–ª—É—á–∏–ª',
            r'–Ω–µ\s*–ø–æ–ª—É—á–∏–ª–∏',
            r'–Ω–µ\s*–ø–æ—Å—Ç—É–ø–∞–ª',
            r'–Ω–µ—Ç\s*–±–∏–ª–µ—Ç',
            r'–±–∏–ª–µ—Ç—ã\s*–Ω–µ',
            r'–Ω–µ\s*–ø—Ä–∏—Ö–æ–¥—è—Ç',
            r'–Ω–µ\s*–¥–æ—à–ª–∏',
            r'–ø–∏—Å—å–º–æ\s*–Ω–µ',
            r'–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å',
            r'–Ω–µ—Ç –±–∏–ª–µ—Ç–æ–≤'
        ]
        
        message_lower = message.text.lower()
        if any(re.search(pattern, message_lower) for pattern in ticket_problem_patterns):
            # –ù–∞—á–∏–Ω–∞–µ–º —Å–µ—Å—Å–∏—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤
            ticket_recovery_handler.start_recovery_session(user_id)
            
            response = (
                "üìß –ü—Ä–æ–±–ª–µ–º—ã —Å –±–∏–ª–µ—Ç–∞–º–∏\n\n"
                "üîç –°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–ª–µ—Ç—ã —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ:\n"
                "1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç Intickets.ru\n"
                "2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É –î–ª—è –∑—Ä–∏—Ç–µ–ª–µ–π\n"
                "3. –í–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å —Å–µ—Ä–≤–∏—Å–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤\n\n"
                "---\n\n"
                "üîÑ –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–ª–µ—Ç—ã:\n"
                "–î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–∏–ª–µ—Ç–æ–≤ —É–∫–∞–∂–∏—Ç–µ:\n\n"
                "‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (6 —Ü–∏—Ñ—Ä) –ò–õ–ò\n"
                "‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –ò–õ–ò\n"
                "‚Ä¢ Email, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫—É–ø–∞–ª–∏ –±–∏–ª–µ—Ç—ã\n\n"
                "‚úÖ –ü—Ä–∏–º–µ—Ä –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞: 123456\n"
                "‚úÖ –ü—Ä–∏–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: +7 (912) 345-67-89\n"
                "‚úÖ –ü—Ä–∏–º–µ—Ä email: example@mail.ru\n\n"
                "–ë–∏–ª–µ—Ç—ã –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç!"
            )
            await message.answer(response, reply_markup=get_main_keyboard())
            return

        # 19. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–ø–ª–∞—Ç–æ–π –ø–æ —Ç–µ–∫—Å—Ç—É (–¥–∞–∂–µ –±–µ–∑ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏)
        payment_problem_patterns = [
            r'\b\d{6}\b.*(?:–ø–ª–∞—Ç[–µ—ë]–∂|–æ–ø–ª–∞—Ç|–¥–µ–Ω—å–≥–∏|—Å–ø–∏—Å–∞–ª–∏—Å—å|–∫–∞—Ä—Ç|–ø—Ä–∏–ª–æ–∂–µ–Ω|qr|–∫–æ–¥)',
            r'(?:–ø–ª–∞—Ç[–µ—ë]–∂|–æ–ø–ª–∞—Ç).*\b\d{6}\b',
            r'–¥–µ–Ω—å–≥–∏.*—Å–ø–∏—Å–∞–ª–∏—Å—å',
            r'—á–µ–∫.*–Ω–µ.*–ø—Ä–∏—à–µ–ª',
            r'–¥–≤–æ–π–Ω.*—Å–ø–∏—Å–∞–Ω',
            r'—Å—Ç–∞—Ç—É—Å.*–æ–∂–∏–¥–∞–µ—Ç.*–æ–ø–ª–∞—Ç',
            r'–ø–ª–∞—Ç–µ–∂.*–Ω–µ.*–ø—Ä–æ—à–µ–ª',
            r'–¥–µ–Ω—å–≥–∏.*–≤–µ—Ä–Ω—É–ª–∏—Å—å'
        ]
        
        message_lower = message.text.lower()
        if any(re.search(pattern, message_lower) for pattern in payment_problem_patterns):
            # –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É —Å –æ–ø–ª–∞—Ç–æ–π, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ payment_handler
            # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è
            if not payment_handler.has_active_session(user_id):
                payment_handler.start_payment_session(user_id)
            
            payment_response = payment_handler.process_payment_message(user_id, message.text)
            if payment_response:
                await message.answer(payment_response, reply_markup=get_main_keyboard())
                return

        # 20. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∏–ª–µ—Ç–æ–≤ - –ü–ï–†–ï–ú–ï–©–ï–ù–û –ù–ò–ñ–ï –ü–†–û–ë–õ–ï–ú –° –ë–ò–õ–ï–¢–ê–ú–ò
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ø–æ—Ç–æ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
        order_match = re.search(r'\b(\d{6})\b', message.text)
        if order_match:
            order_number = order_match.group(1)
            logger.info(f"–ù–∞–π–¥–µ–Ω –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: {order_number}")
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º OrderResponseManager –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
            response = order_manager.get_order_status_response(order_number)
            await message.answer(response, reply_markup=get_main_keyboard())
            return
        
        # 21. –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ - —É—Ç–æ—á–Ω—è–µ–º
        if re.match(r'^\d{6}$', message.text.strip()):
            response = (
                f"üîç –í–∏–∂—É, —á—Ç–æ –≤—ã –≤–≤–µ–ª–∏ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: {message.text}\n\n"
                "–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?\n\n"
                "‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞\n" 
                "‚Ä¢ –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∏–ª–µ—Ç–∞–º–∏\n"
                "‚Ä¢ –í–æ–ø—Ä–æ—Å –ø–æ –æ–ø–ª–∞—Ç–µ\n"
                "‚Ä¢ –í–æ–∑–≤—Ä–∞—Ç –±–∏–ª–µ—Ç–æ–≤\n\n"
                "–û–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ, —á—Ç–æ–±—ã —è –º–æ–≥ –ø–æ–º–æ—á—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ."
            )
            await message.answer(response, reply_markup=get_main_keyboard())
            return
        
        # 22. –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º DeepSeek –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–ø–µ—á–∞—Ç–æ–∫ –∏ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        try:
            logger.info(f"–ò—Å–ø–æ–ª—å–∑—É—é DeepSeek –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–ø–µ—á–∞—Ç–∫–∞–º–∏: {message.text}")
            ai_response = await ds_service.process_message(message.text)
            await message.answer(ai_response, reply_markup=get_main_keyboard())
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ DeepSeek: {e}")
            # –ï—Å–ª–∏ DeepSeek –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            response = (
                "ü§î –ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—à –≤–æ–ø—Ä–æ—Å. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:\n\n"
                "üí≥ **–ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–ª–∞—Ç–æ–π** - –ø–æ–º–æ—â—å —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞–º–∏\n"
                "üìß **–ë–∏–ª–µ—Ç—ã –Ω–µ –ø—Ä–∏—à–ª–∏** - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞\n"
                "üîÑ **–í–æ–∑–≤—Ä–∞—Ç –±–∏–ª–µ—Ç–æ–≤** - –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞\n"
                "üé´ **–ö–∞–∫ –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã** - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–∫—É–ø–∫–µ\n"
                "üìû **–û–ø–µ—Ä–∞—Ç–æ—Ä** - —Å–≤—è–∑—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º\n\n"
                "–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ!"
            )
            await message.answer(response, reply_markup=get_main_keyboard())
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}", exc_info=True)
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ.", 
                           reply_markup=get_main_keyboard())

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    logger.info("=" * 50)
    logger.info("–ó–ê–ü–£–°–ö –ë–û–¢–ê INTICKETS SUPPORT")
    logger.info("=" * 50)
    
    try:
        try:
            async with engine.begin() as conn:
                await conn.run_sync(Base.metadata.create_all)
            logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        except Exception as db_error:
            logger.warning(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î (–±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É): {db_error}")
        
        await bot.delete_webhook(drop_pending_updates=True)
        logger.info("–í–µ–±—Ö—É–∫–∏ –æ—á–∏—â–µ–Ω—ã")
        
        logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        await dp.start_polling(bot)
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: {e}")
        raise

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")